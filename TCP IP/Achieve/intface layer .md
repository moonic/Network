# Interface layer 

* Net/3接口层试图在网络协议和连接到一个系统的网络设备的驱动器间提供一个与硬件无关的编程接口。这个接口层为所有的设备提供以下支持：
  * 精心定义的接口函数；
  * 标准的统计与控制标志；
  * 与设备无关的存储协议地址的方法；
  * 标准的输出分组的排队方法。

* 接口层提供可靠的分组传输，仅要求提供最大努力(best-effort)的服务。更高协议层必须弥补这种可靠性缺陷。本章说明为所有网络接口维护的通用数据结构。为了说明
相关数据结构和算法，我们参考N e t / 3中三种特定的网络接口：
  1. AMD 7990 LANCE以太网接口：一个能广播局域网的例子。
  2. 串行线I P ( S L I P )接口：一个在异步串行线上的点对点网络的例子。
  3. 环回接口：一个逻辑网络把所有输出分组作为输入返回。


* i f n e t结构
  * 结构i f n e t中包含所有接口的通用信息。在系统初始化期间，分别为每个网络设备分配
一个独立的i f n e t结构。每个i f n e t结构有一个列表，它包含这
个设备的一个或多个协议地址。图 3 - 5说明了一个接口和它的地址
之间的关系。
在图3 - 5中的接口显示了 3个存放在i f a d d r结构中的协议地
址。虽然一些网络接口，例如 S L I P，仅支持一个协议；而其他接
口，如以太网，支持多个协议并需要多个地址。例如，一个系统
可能使用一个以太网接口同时用于 I n t e r n e t和O S I两个协议。一个
类型字段标识每个以太网帧的内容，并且因为 I n t e r n e t和O S I协议
使用不同的编址方式，以太网接口必须有一个 I n t e r n e t地址和一个
O S I地址。所有地址用一个链表链接起来 (图3 - 5右侧的箭头)，并
且每个结构包含一个回指指针指向相关的 i f n e t结构(图3 - 5左侧
的箭头)。
可能一个网络接口支持同一协议的多个地址。例如，在 N e t / 3中可能为一个以太网接口分
配两个I n t e r n e t地址。

1. 通用接口信息
  * if_name是一个短字符串，用于标识接口的类型，而if_unit标识多个相同类型的
实例。例如，一个系统有两个 S L I P接口，每个都有一个 i f _ n a m e，包含两字节的“ s 1”和
一个i f _ u n i t。对第一个接口，i f _ u n i t为0；对第二个接口为1。i f _ i n d e x在内核中唯一
地标识这个接口，这在s y s c t l系统调用(见1 9 . 1 4节)以及路由域中要用到。
有时一个接口并不被一个协议地址唯一地标识。例如，几个 S L I P连接可以有同
样的本地I P地址。在这种情况下，i f _ i n d e x明确地指明这个接口。
i f _ f l a g s表明接口的操作状态和属性。一个进程能检查所有的标志，但不能改变在图 3 -
7中“内核专用”列中作了记号的标志。这些标志用 4 . 4节讨论的命令 S I O C G I F F L A G S和
S I O C S I F F L A G S来访问。

2. 接口时钟
8 7 i f _ t i m e r以秒为单位记录时间，直到内核为此接口调用函数 i f _ w a t c h d o g为止。这个
函数用于设备驱动程序定时收集接口统计，或用于复位运行不正确的硬件。
3. BSD分组过滤器
8 8 - 8 9 下面两个成员，i f _ p c o u n t和i f _ b p f，支持B S D分组过滤器( B P F )。通过B P F，一
个进程能接收由此接口传输或接收的分组的备份。


* i f a d d r结构
我们要看的下一个结构是接口地址结构， i f a d d r，它显示在图3 - 1 5中。每个接口维护一
个i f a d d r结构的链表，因为一些数据链路，如以太网，支持多于一个的协议。一个单独的
i f a d d r结构描述每个分配给接口的地址，通常每个协议一个地址。支持多地址的另一个原因
是很多协议，包括T C P / I P，支持为单个物理接口指派多个地址。虽然 N e t / 3支持这个特性，但
很多T C P / I P实现并不支持。
结构i f a d d r通过i f a _ n e x t把分配给
一个接口的所有地址链接起来，它还包括一个指回
接口的i f n e t结构的指针i f a _ i f p。图3 - 1 6显示了
结构i f n e t与i f a d d r之间的关系。
2 2 0 i f a _ a d d r指向接口的一个协议地址，而
i f a _ n e t m a s k指向一个位掩码，它用于选择
i f a _ a d d r中的网络部分。地址中表示网络部分的
比特在掩码中被设置为 1，地址中表示主机的部分
被设置为 0。两个地址都存放在 s o c k a d d r结构中
( 3 . 5节)。图3 - 3 8显示了一个地址及其掩码结构。对
于I P地址，掩码选择I P地址中的网络和子网部分。
2 2 1 - 2 2 3 i f a _ d s t a d d r(或 它 的 别 名
i f a _ b r o a d a d d r)指向一个点对点链路上的另一端
的接口协议地址或指向一个广播网中分配给接口的
广播地址(如以太网)。接口的i f n e t结构中互斥的
两个标志I F F _ B R O A D C A S T和I F F _ P O I N T O P O I N T
(图3 - 7 )指示接口的类型。
2 2 4 - 2 2 8 i f a _ r t r e q u e s t、i f a _ f l a g s和i f a _ m e t r i c支持接口的路由查找。
i f a _ r e f c n t统计对结构i f a d d r的引用。宏I F A F R E E仅在引用计数降到0时才释放这个
结构，例如，当地址被命令 SIOCDIFADDR  ioctl删除时。结构i f a d d r使用引用计数是因
为接口和路由数据结构共享这些结构。


* s o c k a d d r结构
一个接口的编址信息不仅仅只包括一个主机地址。 N e t / 3在通用的s o c k a d d r结构中维护
主机地址、广播地址和网络掩码。通过使用一个通用的结构，将硬件与协议专用的地址细节
相对于接口层隐藏起来。
图3 - 1 7显示的是这个结构的当前定义及早期 B S D版的定义 — 结构o s o c k a d d r。图3 - 1 8
说明了这些结构的组织。
1. S o c k a d d r结构
1 2 0 - 1 2 4 每个协议有它自己的地址格式。 N e t / 3在一个s o c k a d d r结构中处理通用的地址。
s a _ l e n指示地址的长度( O S I和U n i x域协议有不同长度的地址)，s a _ f a m i l y指示地址的类型。
图3 - 1 9列出了地址族(address family)常量，其中包括我们遇到的。
当指明为A F _ U N S P E C时，一个s o c k a d d r的内容要根据情况而定。大多数情况
下，它包含一个以太网硬件地址。
成员s a _ l e n和s a _ f a m i l y允许协议无关代码操作来自多个协议的变长的 s o c k a d d r结
构。剩下的成员s a _ d a t a，包含一个协议相关格式的地址。 s a _ d a t a定义为一个1 4字节的数
组，但当s o c k a d d r结构覆盖更大的内存空间时， s a _ d a t a可能会扩展到2 5 3字节。
每个协议定义一个专用的s o c k a d d r结构，该结构
复制成员s a _ l e n和s a _ f a m i l y，但按那个协议的要
求来定义成员s a _ d a t a。存储在s a _ d a t a中的地址是
一个传输地址；它包含足够的信息来标识同一主机上的多个通信端点。在第 6章我们要查看
I n t e r n e t地址结构s o c k a d d r _ i n，它包含了一个I P地址和一个端口号。
2. O s o c k a d d r结构
2 7 1 - 2 7 4 结构o s o c k a d d r是4.3BSD Reno版本以前的s o c k a d d r定义。因为在这个定义中
一个地址的长度不是显式地可用，所以它不能用来写处理可变长地址的协议无关代码。 O S I协
议使用可变长地址，为了包括 O S I协议，使得在N e t / 3的s o c k a d d r定义中有了我们所见的改
变。结构o s o c k a d d r是为了支持对以前编译的程序的二进制兼容。
在本书中我们省略了二进制兼容代码。


* i f n e t与i f a d d r的专用化
结构i f n e t和i f a d d r包含适用于所有网络接口和协议地址的通用信息。为了容纳其他设
备和协议专用信息，每个设备定义了并且每个协议分配了一个专用化版本的 i f n e t和i f a d d r
结构。这些专用化的结构总是包含一个 i f n e t或i f a d d r结构作为它们的第一个成员，这样
无须考虑其他专用信息就能访问这些公共信息。
多数设备驱动程序通过分配一个专用化的 i f n e t结构的数组来处理同一类型的多个接口，
但其他设备(例如环回设备)仅处理一个接口。图3 - 2 0所示的是我们的例子接口的专用化 i f n e t
结构的组织
每个设备的结构以一个 i f n e t开始，接
下来全是设备相关的数据。环回接口只声名了一个
i f n e t结构，因为它不要求任何设备相关的数据。
在图3 - 2 0中，我们显示的以太网和 S L I P驱动程序的
结构s o f t c带有数组下标 0，因为两个设备都支持
多个接口。任何给定类型的接口的最大个数由内核
建立时的配置参数来限制。
结构a r p c o m(图3 - 2 6 )对于所有以太网设备是通
用的，并且包含地址解析协议 ( A R P )和以太网多播
信息。结构l e _ s o f t c(图3 - 2 5 )包含专用于L A N C E
以太网设备驱动器的其他信息。
每个协议把每个接口的地址信息存储在一个专
用化的i f a d d r结构的列表中。以太网协议使用一
个i n _ i f a d d r结构( 6 . 5节)，而O S I协议使用一个
i s o _ i f a d d r结构。另外，当接口被初始化时，内
核为每个接口分配了一个链路层地址，它在内核中
标识这个接口。
内 核通 过 分 配 一 个 i f a d d r 结 构 和 两 个
s o c k a d d r _ d l结构(一个是链路层地址本身，一个
是地址掩码)来构造一个链路层地址。结构s o c k a d d r _ d l可被O S I、A R P和路由算法访问。图
3 - 2 1显示的是一个带有一个链路层地址、一个 I n t e r n e t地址和一个O S I地址的以太网接口。3 . 11
节说明了链路层地址(i f a d d r和两个s o c k a d d r _ l d结构)的构造和初始化。


  
