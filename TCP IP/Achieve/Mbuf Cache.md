# Mbuf cache 
> m b u f的主要用途是保存在进程和网络接口间互相传递的用户数据。但 m b u f也用于保存其
他各种数据：源与目标地址、插口选项等等。


1) 如果m _ f l a g s等于0，m b u f只包含数据。在m b u f中有1 0 8字节的数据空间(m _ d a t数组)。
指针m _ d a t a指向这1 0 8字节缓存中的某个位置。我们所示的 m _ d a t a指向缓存的起始，
但它能指向缓存中的任意位置。成员 m _ l e n指示了从m _ d a t a开始的数据的字节数。
图1 - 6是这类m b u f的一个例子。
在图2 - 1中，结构m _ h d r中有六个成员，它的总长是 2 0字节。当我们查看此结构的 C语
言定义时，会看见前四个成员每个占用 4字节而后两个成员每个占用 2字节。在图2 - 1中
我们没有区分4字节成员和2字节成员。
2) 第二类m b u f的m _ f l a g s值是M _ P K T H D R，它指示这是一个分组首部，描述一个分组数
据的第一个m b u f。数据仍然保存在这个 m b u f中，但是由于分组首部占用了 8字节，只
有1 0 0字节的数据可存储在这个 m b u f中(在m _ p k t d a t数组中)。图1 - 1 0是这种m b u f的一
个例子。
成员m _ p k t h d r . l e n的值是这个分组的 m b u f链表中所有数据的总长度：即所有通过
m _ n e x t指针链接的 m b u f的m _ l e n值的和，如图 1 - 8所示。输出分组没有使用成员
m _ p k t h d r . r c v i f，但对于接收的分组，它包含一个指向接收接口 i f n e t结构(图3 -
6 )的指针。
3) 下一种m b u f不包含分组首部(没有设置K _ P K T H D R)，但包含超过2 0 8字节的数据，这时
用到一个叫“簇”的外部缓存 (设置M _ E X T)。在此m b u f中仍然为分组首部结构分配了
空间，但没有用 — 在图2 - 1中，我们用阴影显示出来。 N e t / 3分配一个大小为 1 0 2 4或
2 0 4 8字节的簇，而不是使用多个 m b u f来保存数据(第一个带有1 0 0字节数据，其余的每
个带有1 0 8字节数据)。在这个m b u f中，指针m _ d a t a指向这个簇中的某个位置。
N e t / 3版本支持七种不同的结构。定义了四种 1 0 2 4字节的簇(惯例值)，三种2 0 4 8字节的
如果簇的大小是 2 0 4 8，对于以太网
分组(最大1 5 0 0字节)，每个簇大约有四分之一没有用。在 2 7 . 5节中我们会看到 N e t / 3
T C P发送的每个 T C P报文段从来不超过一簇大小，因为当簇的大小为 1 0 2 4时，每个
1 5 0 0字节的以太网帧几乎三分之一未用。但是 [Mogul 1993，图1 5 - 1 5 ]显示了当在以太
网中发送最大帧而不是 1 0 2 4字节的帧时能明显提高以太网的性能。这就是一种性能 /存
储器互换。老的系统使用 1 0 2 4字节簇来节约存储器，而拥有廉价存储器的新系统用
2 0 4 8字节的簇来提高性能。在本书中我们假定一簇的大小是 2 0 4 8字节。


簇 ( c l u s t e r )”用过不同的名字。常量 M C L B Y T E S是这些
缓存( 1 0 2 4或2 0 4 8 )的大小，操作这些缓存的宏的名字是 M C L G E T、M C L A L L O C和
M C L F R E E。这就是为什么称它们为“簇”的原因。但我们还看到 m b u f的标志是
M _ E X T，它代表“外部的”缓存。最后， [ L e ffler et al. 1989]称它们为映射页( m a p p e d
p a g e )。这后一种称法来源于它们的实现，在 2 . 9节我们会看到当要求一个副本时，这
些簇是可以共享的
4) 最后一类 m b u f包含一个分组首部，并包含超过 2 0 8字节的数据。同时设置了标志
M _ P K T H D R和M _ E X T。
对于图2 - 1，我们还有另外几点需要说明：
• m b u f结构的大小总是 1 2 8字节。这意味着图 2 - 1右边两个m b u f在结构m _ e x t后面的未用
空间为8 8字节( 1 2 8-2 0-8-1 2 )。
• 既然有些协议(例如U D P )允许零长记录，当然就可以有m _ l e n为0的数据缓存。
• 在每个m b u f中的成员m _ d a t a指向相应缓存的开始( m b u f缓存本身或一个簇)。这个指针
能指向相应缓存的任意位置，不一定是起始。

