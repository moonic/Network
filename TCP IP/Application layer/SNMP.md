# SNMP: 简单网络管理协议
> 基于T C P / I P的网络管理包含两个部分：网络管理站（也叫管理进程， m a n a g e r）和被管的网络单元（也叫被管设备）
例如：路由器、 X 终端、终端服务器和打印机等,运行 T C P / I P协议管理进程和代理进程之间的通信可以有两种方式
一种是管理进程向代理进程发出请求，询问一个具体的参数值，另外一种方式是代理进程主动向管理进程报告有某些重要的事件发生管理进程除了可以向代理进程询问某些参数值以外，它还可以按要求改变代理进程的参数值


* 基于T C P / I P的网络管理包含3个组成部分：
  1. 一个管理信息库M I B（Management Information Base）。管理信息库包含所有代理进程
的所有可被查询和修改的参数。 RFC 1213 [McCloghrie and Rose 1991]定义了第二版的M I B，
叫做M I B - I I。
  2. 关于 M I B的一套公用的结构和表示符号。叫做管理信息结构 S M I（Structure of
Management Information）。这个在RFC 1155 [Rose and McCloghrie 1990] 中定义。例如：S M I
定义计数器是一个非负整数，它的计数范围是 0~4 294 967 295，当达到最大值时，又从0开始计数。
  3. 管理进程和代理进程之间的通信协议，叫做简单网络管理协议 S N M P（Simple Network
Management Protocol）。在RFC 1157 [Case et al. 1990]中定义。S N M P包括数据报交换的格式
等。尽管可以在运输层采用各种各样的协议，但是在 S N M P中，用得最多的协议还是U D P。

* 协议  
  1. g e t - r e q u e s t操作：从代理进程处提取一个或多个参数值。
  2. g e t - n e x t - r e q u e s t操作：从代理进程处提取一个或多个参数的下一个参数值
  3. s e t - r e q u e s t操作：设置代理进程的一个或多个参数值。
  4. g e t - r e s p o n s e操作：返回的一个或多个参数值。这个操作是由代理进程发出的。它是前面3中操作的响应操作。
  5. t r a p 操作：代理进程主动发出的报文，通知管理进程有某些事情发生。前面的3个操作是由管理进程向代理进程发出的。后面两个是代理进程发给管理进程的
  * 前 4种操作是简单的请求 -应答方式（也就是管理进程发出请求，代理
进程应答响应），而且在S N M P中往往使用U D P协议，所以可能发生管理进程和代理进程之间
数据报丢失的情况。因此一定要有超时和重传机制。
  * 管理进程发出的前面 3种操作采用U D P的1 6 1端口。代理进程发出的 Tr a p操作采用U D P的
1 6 2端口。由于收发采用了不同的端口号，所以一个系统可以同时为管理进程和代理进程
  * 在g e t、g e t - n e x t和s e t的请求数据报中，包含变量名称和变量值的一张表。对于 g e t
和g e t - n e x t操作，变量值部分被忽略，也就是不需要填写。对于t r a p操作符（P D U类型是4），S N M P报文格式有所变化。

* 管理信息结构
  * INTEGER。一个变量虽然定义为整型，但也有多种形式。有些整型变量没有范围限制，有些整型变量定义为特定的数值（例如，I P的转发标志就只有允许转发时的1或者不允许转发时的2这两种），有些整型变量定义为一个特定的范围（例如，U D P和T C P的端口号就从0到6 5 5 3 5）。
  * DisplayString。0或多个8 bit字节，但是每个字节必须是 A S C I I码（2 6 . 4中有A S C I I字符集）。在M I B - I I中，所有该类型的变量不能超过2 5 5个字符（0个字符是可以的）。
  * NULL。代表相关的变量没有值。例如，在 g e t或g e t - n e x t操作中，变量的值就是N U L L，因为这些值还有待到代理进程处去取。
  * IpAddress。4字节长度的OCTER STRING，以网络序表示的 I P地址。每个字节代表I P地址的一个字段。
  * PhysAddress OCTER STRING类型，代表物理地址（例如以太网物理地址为 6个字节长度）。
  * Counter非负的整数，可从0递增到 23 2 -1（4 294 976 295）。达到最大值后归0。
  * Gauge非负的整数，取值范围为从 0到4 294 976 295(或增或减)。达到最大值后锁定,直到复位。例如，M I B中的t c p C u r r E s t a b就是这种类型的变量的一个例子，它代表目前在E S TA B L I S H E D或C L O S E _ WA I T状态的T C P连接数。
  * T i m e T i c k s。时间计数器, 以0 . 0 1秒为单位递增，但是不同的变量可以有不同的递增幅度。
  所以在定义这种类型的变量的时候，必须指定递增幅度。例如，MIB中的sysUpTime变量就是这种类型的变量，代表代理进程从启动开始的时间长度，以多少个百分之一秒的数目来表示。

* 对象标识符
  * 对象标识是一种数据类型，它指明一种“授权”命名的对象。“授权”的意思就是这些标
识不是随便分配的，它是由一些权威机构进行管理和分配的。
对象标识是一个整数序列，以点（“.”）分隔。这些整数构成一个树型结构，类似于 D N S
（图1 4 - 1）或U n i x的文件系统。对象标识从树的顶部开始，顶部没有标识，以 r o o t表示（这和
U n i x中文件系统的树遍历方向非常类似）。
  * 树上的每个结点同时还有一个文字名例如标识1.3.6.1.2.1就和iso.org.dod.internet.memt.mib对应。
  *  AssignedNumber RFC中列出了在该结点下大约4 0 0个标识。
  * 深入讲解 M I B的时候，这些 C a s e图被用来验证：分组的所有数据路径都是被计数的。
[Rose 1994] 中显示了所有M I B组的C a s e图。

* 简单变量  
  * 通过在其对象标识后面添加“ . 0”来处理的。例如图2 5 - 8中的
计数器udpInDatagrams，它的对象标识是1.3.6.1.2.1.7.1，它的实例标识是1.3.6.1.2.1.7.1 . 0，相对应的文字名称是i s o . o r g . d o d . internet.mgmt.mib.udp.udpInDatagrams . 0。
  * 虽然这个变量处理后通常可以缩写为 udpInDatagrams  0，但我们还是要提醒读者在S N M P报文中该变量的名称是其对象的标识1.3.6.1.2.1.7.1.0
  
* 表格
  * 表格的实例标识就要复杂得多。回顾一下图 2 5 - 8中的UDP 监听表。
每个M I B中的表格都指明一个以上的索引。对于 U D P监听表来说，M I B定义了包含两个变量的联合索引，这两个变量是：u d p L o c a l A d d r e s s，它是一个I P地址；u d p L o c a l P o r t，它是一个整数（在图2 5 - 9中的第1行就显示了这个索引）。
  * 假设在U D P监听表中有3行具体成员：第1行的I P地址是0 . 0 . 0 . 0，端口号是6 7；第2行的I P地址是0 . 0 . 0 . 0，端口号是1 6 1；第3行的I P地址是0 . 0 . 0 . 0，端口号是5 2 0。
  * 如这意味着系统将从端口 6 7（B O O T P服务器）、端口1 6 1（S N M P）和端口 5 2 0（R I P）接受来自任何接口的U D P数据报。表格中的这 3行经过处理后的结果在图 2 5 -1 2中显示。

* 简单变量
  * 对一个路由器取两个U D P组的简单变量值：
其中，- a选项代表要和之通信的代理进程名称， - c选项表示S N M P的共同体名。所谓共
同体名，就是客户进程（在这里指 s n m p i）提供、同时能被服务器进程（这里指代理进程
g a t e w a y）所识别的一个口令，共同体名称是管理进程请求的权限标志。代理进程允许客户
进程用只读共同体名对变量进行读操作，用读写共同体名对变量进行读和写操作。
S n m p i程序的输出提示符是s n m p i >，在后面可以键入如g e t这样的命令，该软件将把它
转化为S N M P中的g e t - r e q u e s t报文。当结束时，键入 q u i t就退出（在后面的例子中，我们
将省略掉q u i t的操作）。
  * 对这两个变量的查询请求是封装在一个 U D P数据报中的，而响应也在一个U D P数据报中。
显示的变量是以其对象标识的形式显示的，这是在 S N M P报文中实际传输的内容。我们必
须指定这两个变量的实例是 0。注意，变量的名称（它的对象标识）同样也在响应中返回。在
下面我们将看到对于g e t - n e x t操作这是必需的

* get-next操作
  * get-next操作是基于 M I B的字典式排序的。在下面的例子中，首先向代理进程询问U D P后的下一个对象标识（由于不是一个叶子对象，没有指定任何实例）。代理进程将返回U D P组中的第1个对象，然后我们继续向代理进程取该对象的下一个对象标识，这时候第 2个对象将被返回。
  * 重复上面的步骤直到取出所有的对象为止。从M I B树的顶点开始，对代理进程一步步地进行查询，就可以得出代理进程处所有的
变量值和标识。该方式的另外一个用处就是可以对表格进行遍历。

* 表格的访问
  * 对于“先列后行”次序的UDP监听表，只要采用前面的简单查询程序一步一步地进行操作，
就可以遍历整个表格。只要从询问代理进程udpTable的下一个变量
  * udpTable不是叶子对象，我们不能指定一个实例，但是get-next操作依然能够返回表格中的
下一个对象。然后就可以以返回的结果为基础进行下一步的操作，代理进程也会以“先列后行”的次序返回下一个变量，这样就可以遍历整个表格。

##  M I B组

* s y s t e m组
  * s y s t e m组非常简单，它包含7个简单变量（例如，没有表格）。的名称、数据类型和描述。
可以对n e t b路由器查询一些简单变量：
  * sysDescrDisplayString系统的文字描述
  * sysObjectIDObjectID在子树1 . 3 . 6 . 1 . 4 . 1中的厂商标识
  * sysUpTimeTimeTicks从系统的网管部分启动以来运行的时间（以百分之一秒为计算单位）
  * sysContactDisplayString • 联系人的名字及联系方式
  * sysNameDisplayString • 结点的完全合格的域名( F Q D N )
  * sysLocationDisplayString • 结点的物理位置
  * sysServices[ 0⋯1 2 7 ] • 指示结点提供的服务的值。该值是此结点所支持的O S I模型中层次的和。根据所提供的服务，将下面的一
些值相加： 0 x 0 1 (物理层)、0 x 0 2（数据链路层）、0 x 0 4（互联网层）、0 x 0 8（端到端的运输层）和 0 x 4 0（应用层）

* interface组
  * 在本组中只定义了一个简单变量，那就是系统的接口数量
  * 在该组中，还有一个表格变量，有 2 2列。表格中的每行定义了接口的一些特征参数。
  * 对于第1个接口，采用g e t操作提取5个变量值，然后用get-next操作提取第2个接口的相同的5个参数。对于第3个接口，同样采用g e t - n e x t操作。
  * 对于S L I P链路的接口类型，所报告的是一个点到点的专用串行链路，而不是 S L I P链路。此外，S L I P链路的速率没有报告

* a t组
  * 地址转换组对于所有的系统都是必需的，但是在 MIB-II中已经没有这个组。从 M I B - I I开始，每个网络协议组（如 I P组）都包含它们各自的网络地址转换表。例如对于IP组，网络地址转换表就是iPNetToMediaTable在该组中，仅有一个由3列组成的表格变量。
  *   s n m p i程序中的一个新命令来转储 ( d u m p )整个表格。向一个叫做 k i n e t i c s的
路由器（该路由器连接了一个 T C P / I P网络和一个A p p l e Ta l k网络）查询其整个 A R P高速缓存。
命令的输出是字典式排序的整个表格内容

* i p组
  * 简单变量和3个表格变量

* i c m p组
  * i c m p组包含4个普通计数器变量（ I C M P报文的输出和输入数量以及 I C M P差错报文的输
入和输出数量）和2 2个其他I C M P报文数量的计数器：11个是输出计数器，另外11个是输入计
数器。
  * 对于有附加代码的 I C M P报文（请回忆一下图 6 - 3中，有 1 5种报文代表目的不可达），
S N M P没有为它们定义专门的计数器

* 接口MTU
  * netb到sun的SLIP连接的M T U。现在可以采用SNMP得到这个 MTU首先从 I P路由表中取到 SLIP连接（140.252.1.2 9）的接口号（ipRouteIfIndex），然后就可以用这个数值进入接口表并且取得想要的 SLIP连接的MTU（通过S L I P的描述和数据类型）。
  * 即使连接的类型是 S L I P连接，但是M T U仍设置为以太网，其值为 1 5 0 0，目的
可能是为了避免分片


* 路由表
  * 从域名服务器返回的第1个I P地址是和客户有相同子网掩码的情况。还介绍了用其他的 I P地址也会
正常工作，但是效率比较低。现在我们从 S N M P的角度来查阅路由表的入口，在这里将用到前
面章节中和I P路由有关的很多相关知识。
  * 路由器g e m i n i是一个多接口主机，有两个以太网接口。首先确认一下两个接口都可以
Te l n e t登录： 


* ASN.1和BER
  * 在正式的S N M P规范中都是采用A S N . 1（Abstract Syntax Notation 1）语法，并且在S N M P
报文中比特的编码采用 B E R（Basic Encoding Rule）。和其他介绍S N M P的书不同，我们有目
的地把A S N . 1和B E R的讨论放到最后。因为如果放在前面讨论，有可能使读者产生混淆而忽
略了S N M P的真正目的是进行网络管理。在这里我们也只是对这两个概念简单地进行解释，
[Rose 1990]的第8章详细讨论了A S N . 1和B E R。
  * A S N . 1是一种描述数据和数据特征的正式语言。它和数据的存储及编码无关。 M I B和
S N M P报文中的所有的字段都是用 A S N . 1描述的。例如：对于 S M I中的i p A d d r e s s数据类型，
A S N . 1是这样描述的IpAddress ::=
              [APPLICATION 0] -- in network-byte order
            IMPLICIT OCTET STRING (SIZE (4))
* SNMPv2
  * 在1 9 9 3年，发表了定义新版本S N M P的11个R F C。RFC 1441 [Case et al. 1993]是其中的第
一个，它系统地介绍了S N M P v 2。同样，有两本书 [Stallings 1993; Rose 1994]也对S N M P v 2进
行了介绍。现在已经有两个 S N M P v 2的基本模型（参见附录 B . 3中的[Rose 1994]），但是厂家
的实现到1 9 9 4年才能广泛使用。
  1. 在S N M P v 2中定义了一个新的分组类型g e t - b u l k - r e q u e s t，它高效率地从代理进程读取大块数据。
  2. 另的一个新的分组类型是i n f o r m - r e q u e s t，它使一个管理进程可以向另一个管理进程发送信息。
  3. 定义了两个新的M I B，它们是：SNMPv2 MIB和SNMPv2-M2M MIB（管理进程到管理进程的M I B）。
  4. SNMPv2的安全性比S N M P v 1大有提高。在S N M P v 1中，从管理进程到代理进程的共同体名称是以明文方式传送的。而SNMP v2可以提供鉴别和加密。厂家提供的设备支持S N M P v 2的会越来越多，管理站将对两个版本的 S N M P代理进程进行管理。[Routhier 1993]中描述了如何将S N M P v 1的实现扩展到支持S N M P v 2。

## 小结

* S N M P是一种简单的、S N M P管理进程和S N M P代理进程之间的请求-应答协议。M I B定义
了所有代理进程所包含的、能够被管理进程查询和设置的变量，这些变量的数据类型并不多。
所有这些变量都以对象标识符进行标识，这些对象标识符构成了一个层次命名结构，由
一长串的数字组成，但通常缩写成人们阅读方便的简单名字。一个变量的特定实例可以用附
加在这个对象标识符后面的一个实例来标识。
  * 很多S N M P变量是以表格形式体现的。它们有固定的栏目，但有多少条记录并不固定。对
于S N M P来讲，重要的是对表格中的每一行如何进行标识（尤其当我们不知道表格中有多少条
记录时）以及如何按字典方式进行排序（“先列后行”的次序）。最后要说明的一点是：
  * S N M P的g e t - n e x t操作符对任何S N M P管理进程来讲都是最基本的操作。
然后我们介绍了下列的S N M P变量组：s y s t e m、i n t e r f a c e、address translation、I P、I C M P、T C P
和U D P。接着是两个例子，一个介绍如何确定一个接口的M T U，另外一个介绍如何获取路由器的路由信息。
  * S N M P的t r a p操作，它是当代理进程发生了某些重大事件后主动向管理进程报告的。最后我们简单介绍了 A S N . 1和B E R，这两个概念比较繁琐，但所幸的是
