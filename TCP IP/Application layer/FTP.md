# FTP：文件传送协议
> 用于文件传输的 I n t e r n e t标准。我们必须分清文件传送（file transfer）和文件存取(file access)之间的区别，前者是FTP提供的后者是如 N F S等应用系统提供的。由 F T P提供的文件传送是将一个完整的文件从一个系统复制到另一个系统中。
要使用 F T P，就需要有登录服务器的注册帐号，或者通过允许匿名FTP的服务器来使用
 
* 与Telnet类似
  * FTP最早的设计是用于两台不同的主机，这两个主机可能运行在不同的操作系统下、使用不同的文件结构、并可能使用不同字符集。但不同的是，
  * Telnet获得异构性是强制两端都采用同一个标准：使用7比特ASCII码的N V T。而F T P是采用另一种方法来处理不同系统间的差异。F T P支持有限数量的文件类型（A S C I I，二进制，等等）和文件结构（面向字节流或记录）。
  * 参考文献959 [Postel 和 Reynolds 1985] 是F T P的正式规范。该文献叙述了近年来文件传输的历史演变


* FTP协议
  * FTP与我们已描述的另一种应用不同，它采用两个 T C P连接来传输一个文件。
  1. 控制连接以通常的客户服务器方式建立。服务器以被动方式打开众所周知的用于
FTP的端口，等待客户的连接。客户则以主动方式打开 T C P端口2 1，来建立连接。
控制连接始终等待客户与服务器之间的通信。该连接将命令从客户传给服务器，并传回服务器的应答。
由于命令通常是由用户键入的，所以I P对控制连接的服务类型就是“最大限度地减小迟延”。
  2. 每当一个文件在客户与服务器之间传输时，就创建一个数据连接。
  由于该连接用于传输目的，所以I P对数据连接的服务特点就是“最大限度提高吞吐量”。
图27-1描述了客户与服务器以及它们之间的连接情况从图中可以看出，交互式用户通常不处理在控制连接中转换的命令和应答。
这些细节均由两个协议解释器来完成。标有“用户接口”的方框功能是按用户所需提供各种交互界面
（全屏幕菜单选择，逐行输入命令，等等），并把它们转换成在控制连接上发送的FTP命令。
类似地，从控制连接上传回的服务器应答也被转换成用户所需的交互格式。
从图中还可以看出，正是这两个协议解释器根据需要激活文件传送功能。


## FTP协议规范提供了控制文件传送与存储的多种选择

1. 文件类型
  a. ASCII码文件类型 （默认选择）文本文件以NVT ASCII码形式在数据连接中传输。这要求
发方将本地文本文件转换成NVT ASCII码形式，而收方则将NVT ASCII码再还原成本地文本文件。
其中，用NVT ASCII码传输的每行都带有一个回车，而后是一个换行。这意味着收方必须扫描每
个字节，查找C R、L F对（我们在第1 5 . 2节见过的关于T F I P的A S C I I码文件传输情况与此相同）。
  b. EBCDIC文件类型 该文本文件传输方式要求两端都是 E B C D I C系统。
  c. 图像文件类型（也称为二进制文件类型） 数据发送呈现为一个连续的比特流。通常
用于传输二进制文件。
  d. 本地文件类型 该方式在具有不同字节大小的主机间传输二进制文件。每一字节的比特
数由发方规定。对使用8 bit字节的系统来说，本地文件以8 bit字节传输就等同于图像文件传输。

2. 格式控制
该选项只对A S C I I和E B C D I C文件类型有效。
  a. 非打印 （默认选择）文件中不含有垂直格式信息。
  b. 远程登录格式控制 文件含有向打印机解释的远程登录垂直格式控制。
  c. Fortran 回车控制 每行首字符是F o r t r a n格式控制符。


3. 结构
  a. 文件结构 （默认选择）文件被认为是一个连续的字节流。不存在内部的文件结构。
  b. 记录结构 该结构只用于文本文件（A S C I I或E B C D I C）。
  c. 页结构 每页都带有页号发送，以便收方能随机地存储各页。该结构由 TO P S - 20操作系统提供（主机需求R F C不提倡采用该结构）。
4. 传输方式
它规定文件在数据连接中如何传输。
  a. 流方式 （默认选择）文件以字节流的形式传输。对于文件结构，发方在文件尾提
示关闭数据连接。对于记录结构，有专用的两字节序列码标志记录结束和文件结束。
  b. 块方式 文件以一系列块来传输，每块前面都带有一个或多个首部字节。
  c. 压缩方式 一个简单的全长编码压缩方法，压缩连续出现的相同字节。
在文本文件中常用来压缩空白串，在二进制文件中常用来压缩 0字节（这种方式很少使用，也不受支持。
现在有一些更好的文件压缩方法来支持 F T P）。如果算一下所有这些选择的排列组合数，那么对传输和存储一个文件来说就有 7 2种不同的方式。

* 通常由U n i x实现的FTP 客户和服务器把我们的选择限制如下：
  * 类型：A S C I I或图像。
  * 格式控制：只允许非打印。
  * 结构：只允许文件结构。
  * 传输方式：只允许流方式。
  * 这就限制我们只能取一、两种方式： A S C I I或图像（二进制）。
该实现满足主机需求 R F C的最小需求（该 R F C也要求能支持记录结构，但只有操作系统
支持它才行，而U n i x不行）。
  * 很多非U n i x的实现提供了处理它们自己文件格式的 F T P功能。主机需求R F C指出“F T P协
议有很多特征，虽然其中一些通常不实现，但对 F T P中的每一个特征来说，都存在着至少一种
实现”。


* FTP命令
  * 命令和应答在客户和服务器的控制连接上以 NVT ASCII码形式传送。这就要求在每行结尾都要返回C R、L F对（也就是每个命令或每个应答）。
从客户发向服务器的 Te l n e t命令（以I A C打头）只有中断进程（ < I A C , I P >）和Te l n e t的同步信号（紧急方式下 < I A C , D M >）。我们将看到这两条 Te l n e t命令被用来中止正在进行的文件传输，或在传输过程中查询服务器。
  * 另外，如果服务器接受了客户端的一个带选项的 Te l n e t命令（W I L L，W O N T，D O或D O N T），它将以DONT 或W O N T响应。这些命令都是3或4个字节的大写A S C I I字符，其中一些带选项参数。从客户向服务器发送的F T P命令超过3 0种。


* FTP应答
  * 应答都是A S C I I码形式的3位数字，并跟有报文选项。其原因是软件系统需要根据数字代码来
决定如何应答，而选项串是面向人工处理的。由于客户通常都要输出数字应答和报文串，一个可
交互的用户可以通过阅读报文串（而不必记忆所有数字回答代码的含义）来确定应答的含义。
应答3位码中每一位数字都有不同的含义（我们将在第 2 8章看到简单邮件传送输协议，
S M T P，使用相同的命令和应答约定）。 
• 125 数据连接已经打开；传输开始。
• 200 就绪命令。
• 214 帮助报文（面向用户）。
• 331 用户名就绪，要求输入口令。
• 425 不能打开数据连接。
• 452 错写文件。
• 500 语法错误（未认可的命令）。
• 501 语法错误（无效参数）。
• 502 未实现的M O D E (方式命令)类型。

* 连接管理
数据连接有以下三大用途：
1) 从客户向服务器发送一个文件。
2) 从服务器向客户发送一个文件。
3) 从服务器向客户发送文件或目录列表。
F T P服务器把文件列表从数据连接上发回，而不是控制连接上的多行应答。这就避免了行
的有限性对目录大小的限制，而且更易于客户将目录列表以文件形式保存，而不是把列表显
示在终端上。
控制连接一直保持到客户-服务器连接的全过程，但数据连接可以根据需要
随时来，随时走。那么需要怎样为数据连接选端口号，以及谁来负责主动打开和被动打开？
首先，我们前面说过通用传输方式（ U n i x环境下唯一的传输方式）是流方式，并且文件
结尾是以关闭数据连接为标志。这意味着对每一个文件传输或目录列表来说都要建立一个全
新的数据连接。其一般过程如下：
1) 正由于是客户发出命令要求建立数据连接，所以数据连接是在客户的控制下建立的。
2) 客户通常在客户端主机上为所在数据连接端选择一个临时端口号。客户从该端口发布
一个被动的打开。
3) 客户使用P O RT命令从控制连接上把端口号发向服务器。
4) 服务器在控制连接上接收端口号，并向客户端主机上的端口发布一个主动的打开。服
务器的数据连接端一直使用端口2 0。

* 连接管理：默认数据端口
如果客户没有向服务器发出 P O RT命令，来指明客户数据连接端的端口号，服务器就用与
控制连接正在用的相同的端口号给数据连接。这会给使用流方式（ Unix FTP客户和服务器一
直使用）的客户带来一些问题。正如下面所示：
Host Requirements RFC建议使用流方式的F T P客户在每次使用数据连接前发一个
PORT命令来启用一个非默认的端口号。
回到先前的例子（图2 7 - 6），如果我们要求在列出第 1个目录后几秒钟再列出另一个目录，
那该怎么办？客户将要求其内核选择另一个临时端口号（可能是 11 7 5），下一个数据连接将建
立在s v r 4端口11 7 5和b s d i端口2 0之间。但在图2 7 - 7中服务器执行数据连接的主动打开，我们在
1 8 . 6节说明了服务器将不把端口 2 0分配给新的数据连接，这是因为本地端口号已被更早的连
接使用，而且还处于2 M S L等待状态。
服务器通过指明我们在1 8 . 6节中提到的S O _ R E U S E A D D R选项，来解决这个问题。这让它
把端口2 0分配给新连接，而新连接将从处于 2 M S L等待状态的端口（11 7 4）处得到一个不一样
的外部端口号（11 7 5），这样一切都解决了。
如果客户不发送P O RT命令，而在客户上指明一个临时端口号，那么情况将改变。我们可
以通过执行用户命令s e n d p o r t给F T P来使之发生。Unix FTP客户用这个命令在每个数据连接使
用之前关闭向服务器发送P O RT命令。
图2 7 - 8给出了用于两个连续L I S T命令的数据连接时间系列。控制连接起自主机 s v r 4上的端
口11 7 6，所以在没有P O RT命令的情况下，客户和服务器给数据连接使用相同的端口号（除去
了窗口通知和服务类型值）。
2) 当客户为端口11 7 6上的数据连接做被动打开时，由于该端口已被客户上的控制连接使
用，所以必须确定S O _ R E U S E A D D R选项。
3) 服务器给端口2 0到端口11 7 6的数据连接（报文段1）做主动打开。即便端口11 7 6已在客
户上被使用，客户仍会接受它（报文段 2），这是因为下面这一对插口是不同的：
<svr4, 1176, bsdi, 21>
<svr4, 1176, bsdi, 20>
（在b s d i上的端口号是不同的）。T C P通过查看源I P地址、源端口号、目的 I P地址、目
的端口号分用各呼入报文段，只要这 4个元素中的一个不同，就行。
4) 服务器对数据连接（报文段 5）做主动的关闭，即把这对插口置入服务器上的一个
2 M S L等待。
<svr4, 1176, bsdi, 20>
5) 客户在控制连接上发送另一个 L I S T命令（这里我们不展示）。在此之前，客户在端口
11 7 6上为其数据连接端做一个被动打开。客户必须再一次指明 S O _ R E U S E A D D R，这是
因为端口号11 7 6已在使用。

6) 服务器给从端口2 0到端口11 7 6的数据连接发出一个主动打开。在此之前，服务器必须指
明S O _ R E U S E A D D R，这是因为本地端口（2 0）与处于2 M S L等待状态的连接是相关联的，
但从1 8 . 6节所示可知，该连接将不成功。其原由是这个连接用插口对 (socket pair)与步骤
4中的仍处于2 M S L等待状态的插口对相同。T C P规定禁止服务器发送同步信息（S Y N）。
这样就没办法让服务器跨过插口对的2 M S L等待状态来重用相同的插口对。
在这一步伯克利软件分发（B S D）服务器每隔5秒就重试一次连接请求，直到满1 8次，总共
9 0秒。我们看到报文段9将在大约1分钟后成功（我们在第1 8章提到过，S V R 4使用一个3 0秒
的M S L，以两个M S L来达到持续1分钟的等待）。我们没看到在这个时间系列上的这些失败
有任何同步（S Y N）信息，这是因为主动打开失败，服务器的T C P不再发送一个S Y N。
Host Requirements RFC建议使用P O RT命令的原因是在两个相继使用数据连接之间避免出
现这个2 M S L。通过不停地改变某一端的端口号，我们所说的这个问题就不会出现。

* 建立一个全新的数据连接过程
控制连接一直保持到客户-服务器连接的全过程，但数据连接可以根据需要
随时来，随时走。那么需要怎样为数据连接选端口号，以及谁来负责主动打开和被动打开？
首先，我们前面说过通用传输方式（ U n i x环境下唯一的传输方式）是流方式，并且文件
结尾是以关闭数据连接为标志。这意味着对每一个文件传输或目录列表来说都要建立一个全
新的数据连接。其一般过程如下：
1) 正由于是客户发出命令要求建立数据连接，所以数据连接是在客户的控制下建立的。
2) 客户通常在客户端主机上为所在数据连接端选择一个临时端口号。客户从该端口发布
一个被动的打开。
3) 客户使用P O RT命令从控制连接上把端口号发向服务器。
4) 服务器在控制连接上接收端口号，并向客户端主机上的端口发布一个主动的打开。服
务器的数据连接端一直使用端口2 0。

* 连接管理：临时数据端口
先看一下F T P的连接管理，它只在服务器上用简单 F T P会话显示一个文件。我们用- d标志
（d e b u g）来运行s v r 4主机上的客户。这告诉它要打印控制连接上变换的命令和应答。所有前
面冠以- - - >的行是从客户上发向服务器的，所有以 3位数字开头的行都是服务器的应答。客户
的交互提示是f t p >
F T P客户提示我们注册姓名时，它打印了默认值（我们在客户上的注册名）。当我们敲
R E T U R N键时，默认值被发送出去。
对一个文件列出目录的要求引发一个数据连接的建立和使用。本例体现了我们在图 2 7 - 4
和图2 7 - 5中给出的程序。客户要求 T C P为其数据连接的终端提供一个临时端口号，并用 P O RT
命令发送这个端口号（11  z7 4）给服务器。我们也看到一个交互用户命令（ d i r）成为两个F T P
命令（P O RT和L I S T）




