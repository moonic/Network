# Link layer

* 为IP模块发送和接收IP数据报；
* 为ARP模块发送A RP请求和接收ARP应答；
* 为RARP发送RARP请求和接收RARP应答。TC/IP支持多种不同的链路层协议，取决于网络所使用的硬件
  * 如以太网、令牌环网、FDDI（光纤分布式数据接口）及R S-232串行线路等。


## 链路层协议
* 两个串行接口链路层协议（SLIP和PPP）
* 以及大多数实现都包含的环回（loopback）驱动程序。
* 以太网和SLIP是本书中大多数例子使用的链路层 对MTU（最大传输单元）这如何为串行线路选择 M T U。


## 以太网和IEEE 802封装

* 以太网这个术语一般是指数字设备公司英特尔公司和Xerox公司在1982年联合公布的一个标准它是TCP/IP采用的主要的局域网技术
 * 采用一种称作 CSMA/C D的媒体接入方法，其意思是带冲突检测的载波侦听多路接入（Carrier Sense, Multiple Access with Collision Detection）它的速率为10 Mb/s，地址为48 bit
* IEEE（电子电气工程师协会） 802委员会公布了一个稍有不同的标准集
  * 8023针对整个CSMA/CD网络
  * 802.4针对令牌总线网络
  * 802.5针对令牌环网络。
    * 这三者的共同特性由802.2标准来定义，那就是802网络共有的逻辑链路控制（LLC）
    * 不幸的是，802.2和802.3定义了一个与以太网不同的帧格式
      * 文献 [Stallings 1987]对所有的IEEE 802标准进行了详细的介绍
    
* TCP/IP中以太网
  * IP数据报封装是在RFC 894[Hornig 1984]中定义的
  * IEEE 802网络的IP数据报封装是在RFC 1042[Postel and Reynolds 1988]中定义的 
    1. 必须能发送和接收采用RFC 894（以太网）封装格式的分组。
    2. 应该能接收与RFC 894混合的RFC 1042（IEEE 802）封装格式的分组。
    3. 也许能够发送采用RFC 1042格式封装的分组 如果主机能同时发送两种类型的分组数据 
    4. 发送的分组必须是可以设置的而且默认条件下必须是 RFC 894分组
  * 常使用的封装格式是 RFC 894定义的格式
  * 802定义的有效长度值与以太网的有效类型值无一相同，这样，就可以对两种帧格式进行区分
  
*  在以太网帧格式中，类型字段之后就是数据；而在 8 0 2帧格式中，跟随在后面的是 3字节的802.2 LLC和5字节的802.2 SNAP。
 * 目的服务访问点（ Destination Service Access Point,DSAP）和源服务访问点（Source Service Access Point, SSAP)值都设为0xaaCtrl字段的值设为3。随后的3个字节orgcode都置为0。再接下来的2个字节类型字段和以太网帧格式一样（其他类型字段值可以参见RFC 1340
  * CRC字段用于帧内后续字节差错的循环冗余码检验（检验和）（它也被称为FCS或帧检验序列）。
 
 ---

* 尾部封装
  * RFC 893描述了另一种用于以太网的封装格式，称作尾部封装（trailer encapsulation）
  * 早期BSD系统在DEC VA X机上运行时的试验格式，通过调整I P数据报中字段的次序来提高性能。
  * 以太网数据帧中，开始的那部分是变长的字段（IP首部和TCP首部）移到尾部（在 CR C之前）数据复制到内核时 可以把数据帧中的数据部分映射到一个硬件页面，节省内存到内存的复制过程。
  * TCP数据报的长度是52字节的整数倍，可以用内核中的页表来处理。两台主机通过协商使用 ARP扩展协议对数据帧进行尾部封装。
 ---
 
### SLIP：串行线路IP
> SLIP的全称是Serial Line IP串行线路上对I P数据报进行封装的简单形式
SLIP适用于家庭中每台计算机几乎都有的 R S - 2 3 2串行端口和高速调制解调器接入Internet
  * SLIP协议定义的帧格式
    1. IP数据报以一个称作END（0xc0）的特殊字符结束。防止数据报到来之前的线路噪声被当成数据报内容，多数实现在数据报的开始处也传一个 END字符
      * 如果有线路噪声，那么END字符将结束这份错误的报文。这样当前的报文得以正确地传输，而前一个错误报文交给上层后，会发现其内容毫无意义而被丢弃
    2. 如果IP报文中某个字符为END那么就要连续传输两个字节0xdb和0xdc来取代0xdb这个特殊字符被称作SLIP的ESC字符但是它的值与ASCII码的ESC字符不同
    3. 如果IP报文中某个字符为SLIP的ESC字符 要连续传输两个字节 0 x d b和0 x d d来取代
    
* CSLIP(压缩的SLIP)
  * 串行线路的速率通常较低（19200 b/s或更低） 通信经常是交互式的（如Telnet和Rlogin，二者都使用TCP）
  * 因此在S L I P线路上有许多小的TCP分组进行交换 为了传送1个字节的数据需要20个字节的I P首部和20个字节的TCP首部，总数超过4 0个字节
 *  C S L I P一般能把上面的40个字节压缩到3或5个字节。它能在C S L I P的每一端维持多达16个T C P连接，知道其中连接的首部中的部分字段一般不会发生变化


### PPP：点对点协议
> PPP 点对点协议修改了SLIP协议中的所有缺陷 

* PPP包括以下三个部分：
  1.  串行链路封装IP数据报的方法。
    * PPP既支持数据为8位和无奇偶检验的异步模式  还支持面向比特的同步链接。
  2. 建立、配置及测试数据链路的链路控制协议  LCP：Link Control Protocol
    * 允许通信双方进行协商，确定不同的选项。
  3. 针对不同网络层协议的网络控制协议（ NCP：Network Control Protocol）体系。
    * RFC定义的网络层有IP、OSI网络层、DECnet以及AppleTalk。
      * 例如，IP NCP允许双方商定是否对报文首部进行压缩，类似于C S L I P（缩写词N C P也可用在TCP的前面。

* PPP数据帧的格式看上去很像 ISO的HDLC（高层数据链路控制）标准 PPP数据帧的格式每一帧都以标志字符0x7e开始和结束。
* 紧接着是一个地址字节，值始终是0xff，然后是一个值为0x03的控制字节。

* C R C字段（或F C S，帧检验序列）是一个循环冗余检验码，以检测数据帧中的错误。
  * 标志字符的值是 0 x 7 e，因此当该字符出现在信息字段中时， P P P需要对它进行转义。在同步链路中，该过程是通过一种称作比特填充 (bit stuff i ng)的硬件技术来完成的[Tanenbaum1989]。在异步链路中，特殊字符0x7d用作转义字符出现在PPP数据帧中时 
  * 紧接着的字符的第6个比特要取其补码，具体实现过程如下
    1. 到字符0x7e时，需连续传送两个字符：0 x 7 d和0 x 5 e，以实现标志字符的转义。
    2. 到转义字符0x7d时，需连续传送两个字符：0 x 7 d和0 x 5 d，以实现转义字符的转义。
    3. 默认情况下，如果字符的值小于 0x20（如，一个ASCII控制字符），一般都要进行转义。
      * 例如，遇到字符0 x 0 1时需连续传送 x7d和0 x21两个字符（第6个比特取补码后变为1，而前面两种情况均把它变为0）。控制字符解释成特殊的含义。另一种可能是用链路控制协议来指定是否需要对这3 2个字符中的某一些值进行转义。默认情况下是对所有的 3 2个字符都进行转义


* 环回接口
  * 大多数的产品都（ Loopback Interface），以允许运行在同一台主机上的客户
  * 程序和服务器程序通过 T C P / I P进行通信。A类网络号1 2 7就是为环回接口预留的。根据惯例，
  * 把IP地址127.0.0.1分配给这个接口，并命名为locations一个传给环回接口的I P数据报不能在任何网络上出现。



* 图中需要指出的关键点是：
  1. 传给环回地址（一般是127.0.0.1）的任何数据均作为I P输入。
  2. 传给广播地址或多播地址的数据报复制一份传给环回接口，然后送到以太网上。这是因为广播传送和多播传送的定义（第 1 2章）包含主机本身。
  3. 任何传给该主机I P地址的数据均送到环回接口。看上去用传输层和 I P层的方法来处理环回数据似乎效率不高，但它简化了设计环回接口可以被看作是网络层下面的另一个链路层。网络层把一份数据报传送给环回接口，就像传给其他链路层一样，只不过环回接口把它返回到 I P的输入队列中。



* 串行线路吞吐量计算
 * 线路速率是9600 b/s，而一个字节有8  bit，加上一个起始比特和一个停止比特，那么线路的速率就是960 B/s（字节/秒）。以这个速率传输一个1 0 2 4字节的分组需要1066 ms。如果
  * 用S L I P链接运行一个交互式应用程序，同时还运行另一个应用程序如 FTP发送或接收1 0 24字节的数据，那么一般来说就必须等待一半的时间（ 533 ms）才能把交互式应用程序的分组数据发送出去。
  * 假定交互分组数据可以在其他“大块”分组数据发送之前被发送出去。大多数的 S L I P实现确实提供这类服务排队方法，把交互数据放在大块的数据前面。交互通信一般有 Telnet、Rlogin以及FTP的控制部分（用户的命令，而不是数据）。
  * 这种服务排队方法是不完善的。它不能影响已经进入下游（如串行驱动程序）队列的非交互数据。同时，新型的调制解调器具有很大的缓冲区，因此非交互数据可能已经进入该缓冲区了。

* 对交互应用来说，等待 533 ms是不能接受的。交互时间超过1 0 0～200 ms就被认为是不好的 [Jacobson 1990a]
  * 这是发送一份交互报文出去后，直到接收到响应信息（通常是出现一个回显字符）为止的往返时间。把SLIP的MTU缩短到2 5 6就意味着链路传输一帧最长需要 266 ms，它的一半是 133 ms（这是一般需要等待的时间）
  * IP首部占4 0个字节。由于M T U是I P向链路层查询的结果，因此该值必须包括通常的 T C P和I P首部。
  * 这样就会导致I P如何进行分片的决策。I P对于C S L I P的压缩情况一无所知。平均等待时间的计算（传输最大数据帧所需时间的一半）只适用于SLIP链路（或P P P链路）在交互通信和大块数据传输这两种情况下。
  * 当只有交互通信时，如果线路速率是9600 b/s，那么任何方向上的 1字节数据（假设有 5个字节的压缩帧头）往返一次都大约需要12.5 ms
比前面提到的100~200 ms要小得多。需要注意的是，由于帧头从 4 0个字节压缩到5个字节，使得1字节数据往返时间从85 ms减到12.5 ms。


