# Dynamic routing protocols (动态选路协议)
> 它用于路由器间的通信。我们主要讨论 R I P，即选路信息协议(Routing Infromation Protocol)多数TCP/IP实现都提供这个应用广泛的协议。然后讨论两种新的选路协议OSPF和BGP无分类域间选路的新的选路技术 现在Internet上正在开始采用该协议以保持B类网络的数量

* 静态选路
  * 在配置接口时，以默认方式生成路由表项（对于直接连接的接口），并通过route令增加表项（通常从系统自引导程序文件）
  * 或是通过I C M P重定向生成表项（通常是在默认方式出错的情况下）。在网络很小，且与其他网络只有单个连接点且没有多余路由时（若主路由失败，可以使用备用路由），采用这种方法是可行的 如果上述三种情况不能全满足，通常使用动态选路
  
* 动态选路
  * 当相邻路由器之间进行通信，以告知对方每个路由器当前所连接的网络，这时就出现了动态选路。路由器之间必须采用选路协议进行通信，这样的选路协议有很多种。
  * 路由器上有一个进程称为路由守护程序（ routing daemon）运行选路协议，与其相邻的一些路由器进行通信。正如图9 - 1所示，路由守护程序根据它从相邻路由器接收到的信息，更新内核中的路由表
  * 动态选路并不改变我们在 9 . 2节中所描述的内核在 I P层的选路方式。这种选路方式称为选路机制（routing mechanism）。
    * 内核搜索路由表，查找主机路由、网络路由以及默认路由的方式并没有改变。仅仅是放置到路由表中的信息改变了 — 当路由随时间变化时，路由是由路由守护程序动态地增加或删除，而不是来自于自引导程序文件中的 r o u t e命令
    * 路由守护程序将选路策略（ routing policy）加入到系统中，选择路由并加入到内核的路由表中。如果守护程序发现前往同一信宿存在多条路由，那么它（以某种方法）将选择最佳路由并加入内核路由表中。如果路由守护程序发现一条链路已经断开（可能是路由器崩溃或电话线路不好），它可以删除受影响的路由或增加另一条路由以绕过该问题。

* Internet采用了许多不同的选路协议。
  * Internet是以一组自治系统(A S，Autonomous System)的方式组织的，每个自治系统通常由单个实体管理。常常将一个公司或大学校园定义为一个自治系统。 N S F N E T的I n t e r n e t骨干网形成一个自治系统，因为骨干网中的所有路由器都在单个的管理控制之下。
  * 每个自治系统可以选择该自治系统中各个路由器之间的选路协议。这种协议我们称之为内部网关协议I G P（Interior Gateway Protocol）或域内选路协议（intradomain routing protocol）。
  * 常用的I G P是选路信息协议 R I P。一种新的I G P是开放最短路径优先 O S P F（Open ShortestPath First）协议。它意在取代R I P。另一种1 9 8 6年在原来N S F N E T骨干网上使用的较早的 I G P协议 — H E L L O，现在已经不用了。
  * 新的RFC [Almquist 1993]规定，实现任何动态选路协议的路由器必须同时支持OSPF和RIP，还可以支持其他IGP协议。1
  * 外部网关协议E G P（Exterier Gateway Protocol）或域内选路协议的分隔选路协议用于不同自治系统之间的路由器。
  * E G P是当前在N S F N E T骨干网和一些连接到骨干网的区域性网络上使用的是边界网关协议B G P（Border Gateway Protocol）。B G P意在取代E G P

## RIP：选路信息协议

* 报文格式 
  * RIP报文包含中在UDP数据报中，如图10-2所示（在第11章中对UDP进行更为详细的描述）。图1 0 - 3给出了使用 I P地址时的R I P报文
格式。
  * 命令字段为1表示请求，2表示应答。还有两个舍弃不用的命令（ 3和4），两个非正式的命令：轮询（ 5）和轮询表项（ 6）。请求表示要求其他系统发送其全部或部分路由表。应答则包含发送者全部或部分路由表。版本字段通常为1，而第2版R I P（1 0 . 5节）将此字段设置为2。紧跟在后面的2 0字节指定地址系列（address family）（对于I P地址来说，其值是2）、IP地址以及相应的度量。在本节的后面可以看出， R I P的度量是以跳计数的。采用这种2 0字节格式的R I P报文可以通告多达 2 5条路由。上限2 5是用来保证RIP报文的总长度为2 0×25 + 4 = 504，小于5 1 2字节。由于每个报文最多携带 2 5个路由，因此为了发送整个路由表，经常需要多个报文。

* 采用RIP协议的routed程序正常运行的结果   RIP常用的U D P端口号是5 2 0
  * 初始化：在启动一个路由守护程序时，它先判断启动了哪些接口，并在每个接口上发送一个请求报文，要求其他路由器发送完整路由表。在点对点链路中，该请求是发送给其他终点的。如果网络支持广播的话，这种请求是以广播形式发送的。目的 U D P端口号是5 2 0（这是其他路由器的路由守护程序端口号）。这种请求报文的命令字段为 1，但地址系列字段设置为 0，而度量字段设置为1 6。这是一种要求另一端完整路由表的特殊请求报文。
  * 接收到请求 
    * 如果是特殊请求，那么路由器就将完整的路由表发送给请求者。
    * 否则，就处理请求中的每一个表项：如果有连接到指明地址的路由，则将度量设置成我们的值，否则将度量置为16（度量为1 6是一种称为“无穷大”的特殊值，它意味着没有到达目的的路由）发回响应
  * 接收到响应。
    * 使响应生效，可能会更新路由表。可能会增加新表项，对已有的表项进行修改，或是将已有表项删除。
  * 定期选路更新
    * 每过3 0秒，所有或部分路由器会将其完整路由表发送给相邻路由器 发送路由表可以是广播形式的（如在以太网上），或是发送给点对点链路的其他终点的。
  * 触发更新。
    * 每当一条路由的度量发生变化时，就对它进行更新。不需要发送完整路由表，而只需要发送那些发生变化的表项。
    * 每条路由都有与之相关的定时器。如果运行 R I P的系统发现一条路由在 3分钟内未更新，就将该路由的度量设置成无穷大（16），并标注为删除。
    * 已经在 6个3 0秒更新时间里没收到通告该路由的路由器的更新了。再过 6 0秒，将从本地路由表中删除该路由，以保证该路由的失效已被传播开。

* 度量
  * R I P所使用的度量是以跳 (hop)计算的。所有直接连接接口的跳数为 1。考虑图1 0 - 4所示的路由器和网络。画出的 4条虚线是广播 R I P报文。路由器R 1通过发送广播到 N1通告它与N2之间的跳数是 1（发送给 N 1的广播中通告它与N 1之间的路由是无用的）。
  * 同时也通过发送广播给N 2通告它与N 1之间的跳数为1。同样，R 2通告它与N 2的度量为1，与N 3的度量为1。
  * 相邻路由器通告它与其他网络路由的跳数为1，那么我们与那个网络的度量就是 2这是因为为了发送报文到该网络，我们必须经过那个路由器。
  * R 2到N 1的度量是2，与R 1到N 3的度量一样。由于每个路由器都发送其路由表给邻站，因此，可以判断在同一个自治系统 A S内到每个网络的路由。如果在该 A S内从一个路由器到一个网络有多条路由，那么路由器将选择跳数最小的路由，而忽略其他路由。跳数的最大值是 1 5，R I P只能用在主机间最大跳数值为 1 5的A S内。度量为16表示到无路由到达该I P地址

### RIP版本2

* RFC 1388 [Malkin 1993a]中对R I P定义进行了扩充，通常称其结果为 R I P - 2。
  * 扩充并不改变协议本身，而是利用图1 0 - 3中的一些标注为“必须为0”的字段来传递一些额外的信息。
  * R I P忽略这些必须为0的字段，那么，R I P和R I P - 2可以互操作。图1 0 - 1 0重新给出了由R I P - 2定义的图。对于R I P - 2来说，其版本字段为2
  * 选路域(routing domain)是一个选路守护程序的标识符，它指出了这个数据报的所有者。在一个U n i x实现中，它可以是选路守护程序的进程号。该域允许管理者在单个路由器上运行多个R I P实例，每个实例在一个选路域内运行 选路标记(routing tag)是为了支持外部网关协议而存在的携带着一个 E G P和B G P的自治系统号。
  * 每个表项的子网掩码应用于相应的 I P地址上。下一站I P地址指明发往目的I P地址的报文该发往哪里该字段为0意味着发往目的地址的报文应该发给发送 R I P报文的系统。R I P - 2提供了一种简单的鉴别机制
  * 可以指定 RIP报文的前2 0字节表项地址系列为 0xffff，路由标记为2。表项中的其余1 6字节包含一个明文口令。R I P - 2除了广播（第1 2章）外，还支持多播可以减少不收听 R I P - 2报文的主机的负载

### OSPF：开放最短路径优先
> O S P F是除R I P外的另一个内部网关协议。它克服了 R I P的所有限制。 RFC 1247 [Moy1 9 9 1 ]描述与采用距离向量的 R I P协议不同的是

*  O S P F
  * 链路状态协议。距离向量的意思是，R I P发送的报文包含一个距离向量（跳数）。每个路由器都根据它所接收到邻站的这些距离向量来更新自己的路由表。
  * 一个链路状态协议中，路由器并不与其邻站交换距离信息。它采用的是每个路由器主动地测试与其邻站相连链路的状态，将这些信息发送给它的其他邻站，而邻站将这些信息在自治系统中传播出去。每个路由器接收这些链路状态信息，并建立起完整的路由表。从实际角度来看，二者的不同点是链路状态协议总是比距离向量协议收敛更快。
  * 收敛的意思是在路由发生变化后，例如在路由器关闭或链路出故障后，可以稳定下来。 [ P e r l m a n1 9 9 2 ]的9 . 3节对这两种类型的选路协议的其他方面进行了比较。
  * O S P F与R I P（以及其他选路协议）的不同点在于， O S P F直接使用I P。也就是说，它并不使用U D P或T C P。对于I P首部的p r o t o c o l字段，O S P F有其自己的值（图3 - 1）。另外，作为一种链路状态协议而不是距离向量协议

* O S P F优于R I P的特点。
  1. OSPF可以对每个 I P服务类型（图 3 - 2）计算各自的路由集。这意味着对于任何目的，可以有多个路由表表项，每个表项对应着一个 I P服务类型。
  2. 给每个接口指派一个无维数的费用。可以通过吞吐率、往返时间、可靠性或其他性能来进行指派。可以给每个I P服务类型指派一个单独的费用。
  3. 当对同一个目的地址存在着多个相同费用的路由时，O S P F在这些路由上平均分配流量。我们称之为流量平衡。
  4. OSPF支持子网：子网掩码与每个通告路由相连。这样就允许将一个任何类型的 I P地址分割成多个不同大小的子网（我们在 3 . 7节中给出了这样的一个例子，称之为变长度子网）。到一个主机的路由是通过全 1子网掩码进行通告的。默认路由是以 I P地址为0 . 0 . 0 . 0、网络掩码为全0进行通告的。
  5. 路由器之间的点对点链路不需要每端都有一个 I P地址，我们称之为无编号网络。这样可以节省I P地址 — 现在非常紧缺的一种资源。
  6. 采用了一种简单鉴别机制。可以采用类似于 R I P - 2机制（1 0 . 5节）的方法指定一个明文口令。
  7. OSPF采用多播（第1 2章），而不是广播形式，以减少不参与 O S P F的系统负载。随着大部分厂商支持OSPF在很多网络中O S P F将逐步取代R I P。

## BGP：边界网关协议
> B G P是一种不同自治系统的路由器之间进行通信的外部网关协议。 B G P是A R PA N E T所使用的老E G P的取代品。RFC1267 [Lougheed and Rekhter 1991] 对第3版的B G P进行了描述。RFC 1268 [Rekhter and Gross 1991] 描述了如何在I n t e r n e t中使用B G P

* B G P系统与其他B G P系统之间交换网络可到达信息。信息包括数据到达这些网络所必须经过的自治系统 A S中的所有路径
* 这些信息足以构造一幅自治系统连接图。然后，可以根据连接图删除选路环，制订选路策略
  * 首先，我们将一个自治系统中的 I P数据报分成本地流量和通过流量。在自治系统中，本地流量是起始或终止于该自治系统的流量。
  * 其信源 I P地址或信宿I P地址所指定的主机位于该自治系统中。其他的流量则称为通过流量 在 I n t e r n e t中使用B G P的一个目的就是减少通过流量。

* 可以将自治系统分为以下几种类型：
  1. 残桩自治系统(stub AS)，它与其他自治系统只有单个连接。 stub AS只有本地流量。
  2. 多接口自治系统(multihomed AS)，它与其他自治系统有多个连接，但拒绝传送通过流量。
  3. 转送自治系统(transit AS)，它与其他自治系统有多个连接，在一些策略准则之下，它可以传送本地流量和通过流量。

* Iinterent的总拓扑结构看成是由一些残桩自治系统、多接口自治系统以及转送自治系统的任意互连。
  * 残桩自治系统和多接口自治系统不需要使用 B G P——它们通过运行E G P在自治系统之间交换可到达信息。
  * B G P允许使用基于策略的选路。由自治系统管理员制订策略，并通过配置文件将策略指定给B G P。制订策略并不是协议的一部分，但指定策略允许 B G P实现在存在多个可选路径时选择路径，并控制信息的重发送。选路策略与政治、安全或经济因素有关。
  * B G P与R I P和O S P F的不同之处在于B G P使用T C P作为其传输层协议。两个运行 B G P的系统之间建立一条T C P连接，然后交换整个B G P路由表。从这个时候开始，在路由表发生变化时，再发送更新信号。
  * B G P是一个距离向量协议，但是与（通告到目的地址跳数的） R I P不同的是，B G P列举了到每个目的地址的路由（自治系统到达目的地址的序列号）。这样就排除了一些距离向量协议的问题。采用16 bit数字表示自治系统标识。B G P通过定期发送k e e p a l i v e报文给其邻站来检测T C P连接对端的链路或主机失败。两个报文之间的时间间隔建议值为 3 0秒。应用层的 k e e p a l i v e报文与TCP的k e e p a l i v e选项（第2 3章）是独立的。


CIDR：无类型域间选路
在第3章中，我们指出了 B类地址的缺乏，因此现在的多个网络站点只能采用多个 C类网
络号，而不采用单个 B类网络号。尽管分配这些 C类地址解决了一个问题（ B类地址的缺乏），
但它却带来了另一个问题：每个 C类网络都需要一个路由表表项。无类型域间选路（ C I D R）
是一个防止I n t e r n e t路由表膨胀的方法，它也称为超网（ s u p e r n e t t i n g）。在RFC 1518 [Rekher
and Li 1993] 和RFC 1519 [Fuller et al. 1993]中对它进行了描述，而[Ford, Rekhter, and Braun
1 9 9 3 ]是它的综述。C I D R有一个Internet Architecture Board’s blessing [Huitema 1993]。R F C
1467 [Topolcic 1993] 对I n t e r n e t中C I D R的开发状况进行了小结。
C I D R的基本观点是采用一种分配多个 I P地址的方式，使其能够将路由表中的许多表项总
和( s u m m a r i z a t i o n )成更少的数目。例如，如果给单个站点分配 1 6个C类地址，以一种可以用总
和的方式来分配这 1 6个地址，这样，所有这 1 6个地址可以参照I n t e r n e t上的单个路由表表项。
同时，如果有8个不同的站点是通过同一个 I n t e r n e t服务提供商的同一个连接点接入 I n t e r n e t的，
且这8个站点分配的8个不同I P地址可以进行总和，那么，对于这 8个站点，在I n t e r n e t上，只需
要单个路由表表项。
要使用这种总和，必须满足以下三种特性：
1) 为进行选路要对多个I P地址进行总和时，这些I P地址必须具有相同的高位地址比特。
2) 路由表和选路算法必须扩展成根据 32 bit IP地址和32 bit掩码做出选路决策。
3) 必须扩展选路协议使其除了32 bit地址外，还要有32 bit掩码。O S P F（1 0 . 6节）和R I P - 2
（1 0 . 5节）都能够携带第4版B G P所提出的32 bit掩码。
例 如 ， RFC 1466 [Gerich 1993] 建 议 欧 洲 新 的 C类 地 址 的 范 围 是 1 9 4 . 0 . 0 . 0～
1 9 5 . 2 5 5 . 2 5 5 . 2 5 5。以1 6进制表示，这些地址的范围是 0 x c 2 0 0 0 0 0 0～0 x c 3 ffffff。它代表了6 5 5 3 6
个不同的C类网络号，但它们地址的高 7 bit是相同的。在欧洲以外的国家里，可以采用 I P地址
为0 x c 2 0 0 0 0 0 0和32 bit 0xfe000000 (254.0.0.0) 为掩码的单个路由表表项来对所有这些 6 5 5 3 6个
C类网络号选路到单个点上。 C类地址的后面各比特位（即在 1 9 4或1 9 5后面各比特）也可以进
行层次分配，例如以国家或服务提供商分配，以允许对在欧洲路由器之间使用除了这 32 bit掩
码的高7 bit外的其他比特进行概括。
C I D R同时还使用一种技术，使最佳匹配总是最长的匹配：即在 32 bit掩码中，它具有最
大值。我们继续采用上一段中所用的例子，欧洲的一个服务提供商可能会采用一个与其他欧
洲服务提供商不同的接入点。如果给该提供商分配的地址组是从 1 9 4 . 0 . 1 6 . 0到194.0.31.255 (16
个C类网络号 )，那么可能只有这些网络的路由表项的 I P地址是 1 9 4 . 0 . 1 6 . 0，掩码为
255.255.240.0 (0xfffff 0 0 0 )。发往1 9 4 . 0 . 2 2 . 1地址的数据报将同时与这个路由表表项和其他欧洲
C类地址的表项进行匹配。但是由于掩码 2 5 5 . 2 5 5 . 2 4 0比2 5 4 . 0 . 0 . 0更“长”，因此将采用具有更
长掩码的路由表表项。
“无类型”的意思是现在的选路决策是基于整个 32 bit IP地址的掩码操作，而不管其 I P地
址是A类、B类或是C类，都没有什么区别。
C I D R最初是针对新的C类地址提出的。这种变化将使I n t e r n e t路由表增长的速度缓慢下来，
但对于现存的选路则没有任何帮助。这是一个短期解决方案。作为一个长期解决方案，如果将
C I D R应用于所有I P地址，并根据各洲边界和服务提供商对已经存在的I P地址进行重新分配（且
所有现有主机重新进行编址！），那么[Ford, Rekhter, and Braun 1993] 宣称，目前包含10 000网
络表项的路由表将会减少成只有2 0 0个表项。

### 小结
* 有两种基本的选路协议，即用于同一自治系统各路由器之间的内部网关协议（ I G P）和用于不同自治系统内路由器通信的外部网关协议（ E G P）。
* 最常用的I G P是路由信息协议（R I P），而O S P F是一个正在得到广泛使用的新I G P。一种新近流行的E G P是边界网关协议（B G P）。
* 第2版R I P是其最近的一个改进版，它支持子网，还有一些其他改进技术。同时也对 O S P F、B G P和无类型域间选路（ C I D R）进行了描述。C I D R是一种新技术，可以减小 I n t e r n e t路由表的大小。
* 域间选路协议（ I D R P）最开始时，是一个为了使用O S I地址而不是I P地址，而进行修改的 B G P版本。Intermediate System to Intermediate
ystem 协议（I S - I S）是O S I的标准I G P。可以用它来选路 C L N P（无连接网络协议），这是一种与I P类似的O S I协议。I S - I S和O S P F相似。
* 动态选路仍然是一个网间互连的研究热点。对使用的选路协议和运行的路由守护程序进行选择，是一项复杂的工作。[Perlman 1992]提供了许多细节
