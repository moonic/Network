# Dynamic routing protocols (动态选路协议)
> 它用于路由器间的通信。我们主要讨论 R I P，即选路信息协议(Routing Infromation Protocol)，大多数T C P / I P实现都提供这个应用广泛的协议。然后讨论两种新的选路协议， O S P F和B G P。本章的最后研究一种名叫无分类域间选路的新的选路技术，现在I n t e r n e t上正在开始采用该协议以保持B类网络的数量

* 静态选路
  * 在配置接口时，以默认方式生成路由表项（对于直接连接的接口），并通过r o u t e命令增加表项（通常从系统自引导程序文件）
  * 或是通过I C M P重定向生成表项（通常是在默认方式出错的情况下）。在网络很小，且与其他网络只有单个连接点且没有多余路由时（若主路由失败，可以使用备用路由），采用这种方法是可行的。如果上述三种情况不能全满足，通常使用动态选路。
  
  动态选路
当相邻路由器之间进行通信，以告知对方每个路由器当前所连接的网络，这时就出现了
动态选路。路由器之间必须采用选路协议进行通信，这样的选路协议有很多种。路由器上有
一个进程称为路由守护程序（ routing daemon），它运行选路协议，并与其相邻的一些路由器
进行通信。正如图9 - 1所示，路由守护程序根据它从相邻路由器接收到的信息，更新内核中的
路由表。
动态选路并不改变我们在 9 . 2节中所描述的内核在 I P层的选路方式。这种选路方式称为选
路机制（routing mechanism）。内核搜索路由表，查找主机路由、网络路由以及默认路由的方
式并没有改变。仅仅是放置到路由表中的信息改变了 — 当路由随时间变化时，路由是由路
由守护程序动态地增加或删除，而不是来自于自引导程序文件中的 r o u t e命令。
正如前面所描述的那样，路由守护程序将选路策略（ routing policy）加入到系统中，选
择路由并加入到内核的路由表中。如果守护程序发现前往同一信宿存在多条路由，那么它
（以某种方法）将选择最佳路由并加入内核路由表中。如果路由守护程序发现一条链路已经断
开（可能是路由器崩溃或电话线路不好），它可以删除受影响的路由或增加另一条路由以绕过
该问题。
在像I n t e r n e t这样的系统中，目前采用了许多不同的选路协议。 I n t e r n e t是以一组自治系统
(A S，Autonomous System)的方式组织的，每个自治系统通常由单个实体管理。常常将一个公
司或大学校园定义为一个自治系统。 N S F N E T的I n t e r n e t骨干网形成一个自治系统，这是因为
骨干网中的所有路由器都在单个的管理控制之下。
每个自治系统可以选择该自治系统中各个路由器之间的选路协议。这种协议我们称之为
内部网关协议I G P（Interior Gateway Protocol）或域内选路协议（intradomain routing protocol）。
最常用的I G P是选路信息协议 R I P。一种新的I G P是开放最短路径优先 O S P F（Open Shortest
Path First）协议。它意在取代R I P。另一种1 9 8 6年在原来N S F N E T骨干网上使用的较早的 I G P
协议 — H E L L O，现在已经不用了。
新的RFC [Almquist 1993]规定，实现任何动态选路协议的路由器必须同时支持
OSPF和RIP，还可以支持其他IGP协议。
外部网关协议E G P（Exterier Gateway Protocol）或域内选路协议的分隔选路协议用于不
同自治系统之间的路由器。在历史上，（令人容易混淆）改进的 E G P有着一个与它名称相同的
协议：E G P。新E G P是当前在N S F N E T骨干网和一些连接到骨干网的区域性网络上使用的是边
界网关协议B G P（Border Gateway Protocol）。B G P意在取代E G P。

RIP：选路信息协议
报文格式
RIP报文包含中在UDP数据报中，如图10-2所示（在第11章中对UDP进行更为详细的描述）。
图1 0 - 3给出了使用 I P地址时的R I P报文
格式。
命令字段为1表示请求，2表示应答。还
有两个舍弃不用的命令（ 3和4），两个非正
式的命令：轮询（ 5）和轮询表项（ 6）。请
求表示要求其他系统发送其全部或部分路由表。应答则包含发送者全部或部分路由表。
版本字段通常为1，而第2版R I P（1 0 . 5节）将此字段设置为2。
紧跟在后面的2 0字节指定地址系列（address family）（对于I P地址来说，其值是2）、I P地
址以及相应的度量。在本节的后面可以看出， R I P的度量是以跳计数的。
采用这种2 0字节格式的R I P报文可以通告多达 2 5条路由。上限2 5是用来保证R I P报文的总
长度为2 0×25 + 4 = 504，小于5 1 2字节。由于每个报文最多携带 2 5个路由，因此为了发送整
个路由表，经常需要多个报文。

正常运行
让我们来看一下采用R I P协议的r o u t e d程序正常运行的结果。R I P常用的U D P端口号是5 2 0。
• 初始化：在启动一个路由守护程序时，它先判断启动了哪些接口，并在每个接口上发送
一个请求报文，要求其他路由器发送完整路由表。在点对点链路中，该请求是发送给其
他终点的。如果网络支持广播的话，这种请求是以广播形式发送的。目的 U D P端口号是
5 2 0（这是其他路由器的路由守护程序端口号）。
这种请求报文的命令字段为 1，但地址系列字段设置为 0，而度量字段设置为1 6。这是一
种要求另一端完整路由表的特殊请求报文。
• 接收到请求。如果这个请求是刚才提到的特殊请求，那么路由器就将完整的路由表发送
给请求者。否则，就处理请求中的每一个表项：如果有连接到指明地址的路由，则将度
量设置成我们的值，否则将度量置为 1 6（度量为1 6是一种称为“无穷大”的特殊值，它
意味着没有到达目的的路由）。然后发回响应。
• 接收到响应。使响应生效，可能会更新路由表。可能会增加新表项，对已有的表项进行
修改，或是将已有表项删除。
• 定期选路更新。每过3 0秒，所有或部分路由器会将其完整路由表发送给相邻路由器。发
送路由表可以是广播形式的（如在以太网上），或是发送给点对点链路的其他终点的。• 触发更新。每当一条路由的度量发生变化时，就对它进行更新。不需要发送完整路由表，
而只需要发送那些发生变化的表项。
每条路由都有与之相关的定时器。如果运行 R I P的系统发现一条路由在 3分钟内未更新，
就将该路由的度量设置成无穷大（ 1 6），并标注为删除。这意味着已经在 6个3 0秒更新时间里
没收到通告该路由的路由器的更新了。再过 6 0秒，将从本地路由表中删除该路由，以保证该
路由的失效已被传播开。
10.4.3 度量
R I P所使用的度量是以跳 ( h o p )计算的。所有直接连接接口的跳数为 1。考虑图1 0 - 4所示的
路由器和网络。画出的 4条虚线是广播 R I P
报文。
路由器R 1通过发送广播到 N 1通告它与
N 2之间的跳数是 1（发送给 N 1的广播中通
告它与N 1之间的路由是无用的）。同时也通
过发送广播给N 2通告它与N 1之间的跳数为
1。同样，R 2通告它与N 2的度量为1，与N 3
的度量为1。
如果相邻路由器通告它与其他网络路
由的跳数为1，那么我们与那个网络的度量就是 2，这是因为为了发送报文到该网络，我们必
须经过那个路由器。在我们的例子中， R 2到N 1的度量是2，与R 1到N 3的度量一样。
由于每个路由器都发送其路由表给邻站，因此，可以判断在同一个自治系统 A S内到每个
网络的路由。如果在该 A S内从一个路由器到一个网络有多条路由，那么路由器将选择跳数最
小的路由，而忽略其他路由。
跳数的最大值是 1 5，这意味着R I P只能用在主机间最大跳数值为 1 5的A S内。度量为1 6表
示到无路由到达该I P地址。
