# DNS(域名系统)
> 用于T C P / I P应用程序的分布式数据库，它提供主机名字和 I P地址之间的转换及有关电子邮件的选路信息。这里提到的分布式是指在 Internet上的单个站点不
能拥有所有的信息。每个站点（如大学中的系、校园、公司或公司中的部门）保留它自己的信息数据库，并运行一个服务器程序供Intrnet上的其他系统（客户程序）查询D N S提供了允许服务器和客户程序相互通信的协议。
 
* DNS解析
  *  对 D N S的访问是通过一个地址解析器（resolver）来完成 在Unix
主机中该解析器主要是通过两个库函数gethostbyname(3)和gethostbyaddr(3)来访问
的，它们在编译应用程序时与应用程序连接在一起。前者接收主机名字返回 I P地址而后者
接收I P地址来寻找主机名字。解析器通过一个或多个名字服务器来完成这种相互转换。
  * 解析器并不像 T C P / I P协议那样是操作系统的内核。该图指出的另一个基本概念就是：
  在一个应用程序请求 T C P打开一个连接或使用U D P发送一个数据报之前
  心须将一个主机名转换为一个 I P地址。操作系统内核中的TCP/IP协议族对于DNS一点都不知道
  * RFC 1034 [Mockapetris 1987a] 说明了D N S的概念和功能，RFC 1035 [Mockapetris 1987b]详细说明了DNS 的规范和实现。=
  D N S最常用的版本（包括解析器和名字服务器）是BIND—伯克利Internet域名服务器。
  该服务器称作named[Danzig、Obraczka和Kumar 1992]分析了DNS 在广域网中产生的通信量

* DNS 基础
  * 每个结点有一个至多6 3个字符长的标识。这颗树的树根是没有任何标识的特殊结点。命名标识中一律不区分大写和小写。命名树上任何一个结点的域名就是将从该结点到最高层的域名串连起来，中间使用一个点“.”分隔这些域名（注意这和 U n i x文件系统路径的形成不同，文件路径是由树根依次向下的形成的域名树中的每个结点必须有一个唯一的域名，但域名树中的不同结点可使用相同的标识。
  * 以点“.”结尾的域名称为绝对域名或完全合格的域名 FQDN（Full Qualified DomainN a m e）
  * 顶级域名被分为三个部分：
    1. a r p a是一个用作地址到名字转换的特殊域
    2. 7个3字符长的普通域。有些书也将这些域称为组织域。
    3. 所有2字符长的域均是基于I S O 3 1 6 6中定义的国家代码，这些域被称为国家域，或地理域
  * 一个独立管理的 DNS子树称为一个区域 ( zone)一个常见的区域是一个二级域，如noao.edu许多二级域将它们的区域划分成更小的区域
    * 例如，大学可能根据不同的系来划分区域，公司可能根据不同的部门来划分区域
    * DNS树中区域的划分同一个逻辑U n i x文件系统到物理磁盘分区的划分很相似

* 区域系统
  * 一旦一个区域的授权机构被委派后，由它负责向该区域提供多个名字服务器。当一个新系统加入到一个区域中时，该区域的 D N S管理者为该新系统申请一个域名和一个 I P地址，并将它们加到名字服务器的数据库中
  * 一个名字服务器负责一个或多个区域。一个区域的管理者必须为该区域提供一个主名字服务器和至少一个辅助名字服务器
  * 主、辅名字服务器的主要区别在于主名字服务器从磁盘文件中调入该区域的所有信息，
而辅名字服务器则从主服务器调入所有信息。我们将辅名字服务器从主服务器调入信息称为
区域传送。
  * D N S的一个基本特性是使用超高速缓存。即当一个名字服务器收到有关映射的信息（主机名字到I P地址）时，它会将该信息存放在高速缓存中。这样若以后遇到相同的映射请求，就能直接使用缓存中的结果而无需通过其他服务器查询。
  
## DNS的报文格式
 QR 是1 bit字段：0表示查询报文，1表示响应报文。
• o p c o d e是一个4 bit字段：通常值为0（标准查询），其他值为1（反向查询）和2（服务器
状态请求）。
• A A是1 bit标志，表示“授权回答 (authoritative answer)。该名字服务器是授权于该域
的。
• T C是1 bit字段，表示“可截断的 (truncated)。使用U D P时，它表示当应答的总长度超
过5 1 2字节时，只返回前5 1 2个字节。
• R D是1 bit字段表示“期望递归（ recursion desired）”。该比特能在一个查询中设置，并
在响应中返回。这个标志告诉名字服务器必须处理这个查询，也称为一个递归查询。如
果该位为0，且被请求的名字服务器没有一个授权回答，它就返回一个能解答该查询的
其他名字服务器列表，这称为迭代查询。在后面的例子中，我们将看到这两种类型查询
的例子。
• R A是1 bit字段，表示“可用递归”。如果名字服务器支持递归查询，则在响应中将该比
特设置为1。在后面的例子中可看到大多数名字服务器都提供递归查询，除了某些根服
务器。
• 随后的3 bit字段必须为0。
• rcode是一个4 bit的返回码字段。通常的值为 0（没有差错）和3（名字差错）。名字差错
只有从一个授权名字服务器上返回，它表示在查询中制定的域名不存在。
随后的 4个16 bit字段说明最后 4个变长字段中包含的条目数。对于查询报文，问题
(question)数通常是1，而其他3项则均为0。类似地，对于应答报文，回答数至少是 1，剩下的
两项可以是0或非0。

### DNS响应报文中的资源记录部分
* D N S报文中最后的三个字段，回答字段、授权字段和附加信息字段，均采用一种称为资
源记录R R（Resource Record）的相同格式
* 域名是记录中资源数据对应的名字。它的格式和前面介绍的查询名字段格式（图 1 4 - 6）
相同。类型说明 R R的类型码。它的值和前面介绍的查询类型值是一样的。类通常为 1，指
I n t e r n e t数据。
* 生存时间字段是客户程序保留该资源记录的秒数。资源记录通常的生存时间值为 2天。
资源数据长度说明资源数据的数量。该数据的格式依赖于类型字段的值。对于类型 1（A
记录）资源数据是4字节的I P地址。

### 指针查询
> D N S中一直难于理解的部分就是指针查询方式，即给定一个 I P地址，返回与该地址对应的域名。

* 查看一下顶级域a r p a，及它下面的i n - a d d r域。当一个组织加入I n t e r n e t，
并获得D N S域名空间的授权，如n o a o . e d u，则它们也获得了对应I P地址的i n - a d d r . a r p a域名
空间的授权。在n o a o . e d u这个例子中，它是网络号为1 4 0 . 2 5 2的B类网络。在D N S树中结点i n -
a d d r . a r p a的下一级必须是该I P地址的第一字节（例中为1 4 0），再下一级为该I P地址的下一个
字节（2 5 2），依此类推。但应牢记的是D N S名字是由D N S树的底部逐步向上书写的。这意味着
对于I P地址为1 4 0 . 2 5 2 . 1 3 . 3 3的s u n主机，它的D N S名字为3 3 . 1 3 . 2 5 2 . 1 4 0 . i n - a d d r . a r p a。
必须写出4字节的I P地址，因为授权的代表是基于网络号： A类地址是第一字节，B类地址
是第一、二字节，C类地址则是第一、二、三字节。I P地址的第一字节一定位于i n - a d d r的下
一级，但F Q D N却是自树底往上书写的。如果F Q D N由顶往下书写，则这个I P地址的D N S名字将
是a r p a . i n - a d d r . 1 4 0 . 2 5 2 . 1 3 . 3 3，而它所对应的域名将是e d u . n o a o . t u c . s u n。
如果D N S树中没有独立的分支来处理这种地址—名字的转换，将无法进行这种反向转换，
除非从树根开始依次尝试每个顶级域。毫不夸张地说，这将需要数天或数周的时间。虽然反
写I P地址和特殊的域名会造成某些混乱，但 i n - a d d r解决方案仍是一种最有效的方式。
只有在使用h o s t程序或t c p d u m p程序直接同D N S打交道时，才会担心i n - a d d r域和反写I P
地址影响我们。从应用的角度上看，正常的名字解析器函数（g e t h o s t b y a d d r）将接收一个I P
地址并返回对应主机的有关信息。反转这些字节和添加i n - a d d r . a r p a域均由该函数自动完成
