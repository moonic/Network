# DNS(域名系统)
> 用于T C P / I P应用程序的分布式数据库，它提供主机名字和 I P地址之间的转换及有关电子邮件的选路信息。这里提到的分布式是指在 Internet上的单个站点不
能拥有所有的信息。每个站点（如大学中的系、校园、公司或公司中的部门）保留它自己的信息数据库，并运行一个服务器程序供Intrnet上的其他系统（客户程序）查询D N S提供了允许服务器和客户程序相互通信的协议。
 
* DNS解析
  *  对 D N S的访问是通过一个地址解析器（resolver）来完成 在Unix
主机中该解析器主要是通过两个库函数gethostbyname(3)和gethostbyaddr(3)来访问
的，它们在编译应用程序时与应用程序连接在一起。前者接收主机名字返回 I P地址而后者
接收I P地址来寻找主机名字。解析器通过一个或多个名字服务器来完成这种相互转换。
  * 解析器并不像 T C P / I P协议那样是操作系统的内核。该图指出的另一个基本概念就是：
  在一个应用程序请求 T C P打开一个连接或使用U D P发送一个数据报之前
  心须将一个主机名转换为一个 I P地址 操作系统内核中的TCP/IP协议族对于DNS一点都不知道
  * RFC 1034 [Mockapetris 1987a] 说明了D N S的概念和功能，RFC 1035 [Mockapetris 1987b]详细说明了DNS 的规范和实现。=
  D N S最常用的版本（包括解析器和名字服务器）是BIND—伯克利Internet域名服务器。
  该服务器称作named[Danzig、Obraczka和Kumar 1992]分析了DNS 在广域网中产生的通信量

* DNS 基础
  * 每个结点有一个至多6 3个字符长的标识。这颗树的树根是没有任何标识的特殊结点。命名标识中一律不区分大写和小写。命名树上任何一个结点的域名就是将从该结点到最高层的域名串连起来，中间使用一个点“.”分隔这些域名（注意这和 U n i x文件系统路径的形成不同，文件路径是由树根依次向下的形成的域名树中的每个结点必须有一个唯一的域名，但域名树中的不同结点可使用相同的标识。
  * 以点“.”结尾的域名称为绝对域名或完全合格的域名 FQDN（Full Qualified DomainN a m e）
  * 顶级域名被分为三个部分：
    1. a r p a是一个用作地址到名字转换的特殊域
    2. 7个3字符长的普通域。有些书也将这些域称为组织域。
    3. 所有2字符长的域均是基于I S O 3 1 6 6中定义的国家代码，这些域被称为国家域，或地理域
  * 一个独立管理的 DNS子树称为一个区域 ( zone)一个常见的区域是一个二级域，如noao.edu许多二级域将它们的区域划分成更小的区域
    * 例如，大学可能根据不同的系来划分区域，公司可能根据不同的部门来划分区域
    * DNS树中区域的划分同一个逻辑U n i x文件系统到物理磁盘分区的划分很相似

* 区域系统
  * 一旦一个区域的授权机构被委派后，由它负责向该区域提供多个名字服务器。当一个新系统加入到一个区域中时，该区域的 D N S管理者为该新系统申请一个域名和一个 I P地址，并将它们加到名字服务器的数据库中
  * 一个名字服务器负责一个或多个区域。一个区域的管理者必须为该区域提供一个主名字服务器和至少一个辅助名字服务器
  * 主、辅名字服务器的主要区别在于主名字服务器从磁盘文件中调入该区域的所有信息，
而辅名字服务器则从主服务器调入所有信息。我们将辅名字服务器从主服务器调入信息称为
区域传送。
  * D N S的一个基本特性是使用超高速缓存。即当一个名字服务器收到有关映射的信息（主机名字到I P地址）时，它会将该信息存放在高速缓存中。这样若以后遇到相同的映射请求，就能直接使用缓存中的结果而无需通过其他服务器查询。
  
## DNS的报文格式
 QR 是1 bit字段：0表示查询报文，1表示响应报文。
• o p c o d e是一个4 bit字段：通常值为0（标准查询），其他值为1（反向查询）和2（服务器
状态请求）。
• A A是1 bit标志，表示“授权回答 (authoritative answer)。该名字服务器是授权于该域
的。
• T C是1 bit字段，表示“可截断的 (truncated)。使用U D P时，它表示当应答的总长度超
过5 1 2字节时，只返回前5 1 2个字节。
• R D是1 bit字段表示“期望递归（ recursion desired）”。该比特能在一个查询中设置，并
在响应中返回。这个标志告诉名字服务器必须处理这个查询，也称为一个递归查询。如
果该位为0，且被请求的名字服务器没有一个授权回答，它就返回一个能解答该查询的
其他名字服务器列表，这称为迭代查询。在后面的例子中，我们将看到这两种类型查询
的例子。
• R A是1 bit字段，表示“可用递归”。如果名字服务器支持递归查询，则在响应中将该比
特设置为1。在后面的例子中可看到大多数名字服务器都提供递归查询，除了某些根服 
务器。
• 随后的3 bit字段必须为0。
• rcode是一个4 bit的返回码字段。通常的值为 0（没有差错）和3（名字差错）。名字差错
只有从一个授权名字服务器上返回，它表示在查询中制定的域名不存在。
随后的 4个16 bit字段说明最后 4个变长字段中包含的条目数。对于查询报文，问题
(question)数通常是1，而其他3项则均为0。类似地，对于应答报文，回答数至少是 1，剩下的
两项可以是0或非0。

### DNS响应报文中的资源记录部分
* D N S报文中最后的三个字段，回答字段、授权字段和附加信息字段，均采用一种称为资
源记录R R（Resource Record）的相同格式
* 域名是记录中资源数据对应的名字。它的格式和前面介绍的查询名字段格式（图 1 4 - 6）
相同。类型说明 R R的类型码。它的值和前面介绍的查询类型值是一样的。类通常为 1，指
I n t e r n e t数据。
* 生存时间字段是客户程序保留该资源记录的秒数。资源记录通常的生存时间值为 2天。
资源数据长度说明资源数据的数量。该数据的格式依赖于类型字段的值。对于类型 1（A
记录）资源数据是4字节的I P地址。

### 指针查询
> D N S中一直难于理解的部分就是指针查询方式，即给定一个 I P地址，返回与该地址对应的域名。

* 查看一下顶级域a r p a，及它下面的in-addr域。当一个组织加入Internet
并获得D N S域名空间的授权，如noao.edu则它们也获得了对应I P地址的in-addr.arpa域名空间的授权。
在D N S树中结点i n -a ddr. a r p a的下一级必须是该I P地址的第一字节（例中为1 4 0），再下一级为该I P地址的下一个字节（2 5 2）牢记的是D N S名字是由D N S树的底部逐步向上书写的对于I P地址为140.252.13.33的sun主机，D N S名字为33.13.252.140.in-ad dr.arpa
必须写出4字节的I P地址，因为授权的代表是基于网络号： A类地址是第一字节，B类地址
是第一、二字节，C类地址则是第一、二、三字节I P地址的第一字节一定位于in-addr的下
一级 但FQD N却是自树底往上书写的。如果FQDN由顶往下书写，则这个I P地址的D N S名字将
是arpa.in-addr.140.252.13.33，而它所对应的域名将是edu.noao.tuc.sun

如果D N S树中没有独立的分支来处理这种地址—名字的转换，将无法进行这种反向转换，
除非从树根开始依次尝试每个顶级域。毫不夸张地说，这将需要数天或数周的时间。虽然反
写I P地址和特殊的域名会造成某些混乱，但 in- addr解决方案仍是一种最有效的方式。
只有在使用host程序或tcpdump程序直接同D N S打交道时，才会担心i n - a d d r域和反写I P
地址影响我们。从应用的角度上看，正常的名字解析器函数（gethostbyaddr）将接收一个I P
地址并返回对应主机的有关信息。反转这些字节和添加in-addr.arpa域均由该函数自动完成

### 主机名检查
> 当一个I P数据报到达一个作为服务器的主机时，无论是 U D P数据报还是T C P连接请求，服
务器进程所能获得的是客户的 I P地址和端口号（U D P或T C P）。某些服务器需要客户的 I P地址
来获得在D N S中的指针记录。在2 7 . 3节会看到这样的例子，从未知的 I P地址使用匿名F T P访问
服务器。

* 如R l o g i n服务器（第2 6章）不但需要客户的I P地址来获得指针记录，还
要向D N S询问该I P地址所对应的域名，并检查返回的地址中是否有地址与收到的数据报中的
源I P地址匹配。该检查是因为 . r h o s t s文件中的条目仅包含主机名，而没有 I P
地址，因此主机需要证实该主机名是否对应源 I P地址。

* 资源记录
  * 不同类型的资源记录（R R）：I P地址查询为A类型，指针查询为类型
P T R。也已看到了由名字服务器返回的资源记录：回答R R、授权R R和附加信息R R。现有大约2 0种
不同类型的资源记录，下面将介绍其中的一些。另外，随着时间的推移，会加入更多类型的R R。

A 一个A记录定义了一个I P地址，它存储32 bit的二进制数。

P T R 指针记录用于指针查询。 I P地址被看作是 i n - a d d r . a r p a域下的一个域名
（标识符串）。

C N A M E 这表示“规范名字(canonical name)”。它用来表示一个域名（标识符串），而
有规范名字的域名通常被称为别名 ( a l i a s )。某些F T P服务器使用它向其他的系
统提供一个易于记忆的别名。
例如，g a t e d服务器（1 0 . 3节提到）可通过匿名F T P从g a t e d . c o r n e l l . e d u
获得，但这里并没有叫做g a t e d的系统，这仅是为其他系统提供的别名。其他
系统的规范名为g a t e d . c o r n e l l . e d u。
sun % host -t cname gated.cornell.edu
gated.cornell.edu CNAM COMET.CIT.CORNELL.EDU
这里使用的- t选项来指明它是特定的查询类型。

H I N F O 表示主机信息：包括说明主机 C P U和操作系统的两个字符串。并非所有的站
点均提供它们系统的H I N F O记录，并且提供的信息也可能不是最新的。
sun % host -t hinfo sun
sun.tuc.noao.edu HINFO Sun-4/25 Sun4.1.3

M X 邮件交换记录，用于以下一些场合：（1）一个没有连到I n t e r n e t的站点能将一个
连到I n t e r n e t的站点作为它的邮件交换器。这两个站点能够用一种交替的方式交
换到达的邮件，而通常使用的协议是U U C P协议。（2）M X记录提供了一种将无
法到达其目的主机的邮件传送到一个替代主机的方式。（3）M X记录允许机构
提供供他人发送邮件的虚拟主机，如c s . u n i v e r s i t y . e d u，即使这样的主机
名根本不存在。（4）防火墙网关能使用M X记录来限制外界与内部系统的连接。
许多不能与I n t e r n e t连接的站点通过 U U C P链路与一个连接在 I n t e r n e t上的站点
如U U N E T相连接。通过M X记录能使用u s e r @ h o s t这种邮件地址向那个站点
发送电子邮件。例如，一个假想的域 f o o . c o m可能有下面的M X记录：

M X记录能被连接在互联网主机中的邮件处理器使用。在这个例子中，其他的
邮件处理器则被告知“如果有邮件要发往 u s e r @ f o o . c o m，就将邮件送到
r e l a y 1 . u u . n e t或r e l a y 2 . u u . n e t。”
每个M X记录被赋于一个 16 bit的整数值，该值称为优先值。如果一个目的主
机有多个M X记录，它们按优先值由小到大的顺序使用。
另一个M X记录的例子是处理主机脱机工作或不可达的情况。邮件处理器仅在
无法使用T C P与目的主机连接时才使用 M X记录。


* 高速缓存
为了减少I n t e r n e t上D N S的通信量，所有的名字服务器均使用高速缓存。在标准的 U n i x实
现中，高速缓存是由名字服务器而不是由名字解析器维护的。既然名字解析器作为每个应用
的一部分，而应用又不可能总处于工作状态，因此将高速缓存放在只要系统（名字服务器）
处于工作状态就能起作用的程序中显得很重要。这样任何一个使用名字服务器的应用均可获
得高速缓存。在该站点使用这个名字服务器的任何其他主机也能共享服务器的高速缓存。
