# IP选路
选路是I P最重要的功能之一。图 9 - 1是I P层处理过程的简单流程。需要进行选路的数据报
可以由本地主机产生，也可以由其他主机产生。在后一种情况下，主机必须配置成一个路由
器，否则通过网络接口接收到的数据报，如果目的地址不是本机就要被丢弃（例如，悄无声
息地被丢弃）。
在图9 - 1中，我们还描述了一个路由守护程序（ d a e m o n），通常这是一个用户进程。在
U n i x系统中，大多数普通的守护程序都是路由程序和网关程序（术语 d a e m o n指的是运行在后
台的进程，它代表整个系统执行某些操作。 d a e m o n一般在系统引导时启动，在系统运行期间
一直存在）。在某个给定主机上运行何种路由协议，如何在相邻路由器上交换选路信息，以及
选路协议是如何工作的，所有这些问题都是非常复杂的，其本身就可以用整本书来加以讨论
（有兴趣的读者可以参考文献 [Perlman 1992]以获得更详细的信息）。在第1 0章中，我们将简单
讨论动态选路和选路信息协议 R I P（Routing Information Protocol）。在本章中，我们主要的目
的是了解单个I P层如何作出路由决策。
图9 - 1所示的路由表经常被 I P访问（在一个繁忙的主机上，一秒钟内可能要访问几百次），
但是它被路由守护程序更新的频度却要低得多（可能大约 3 0秒种一次）。当接收到I C M P重定
向，报文时，路由表也要被更新，这一点我们将在 9 . 5节讨论r o u t e命令时加以介绍。在本章中，
我们还将用n e t s t a t命令来显示路由表。


* 选路的原理
开始讨论I P选路之前，首先要理解内核是如何维护路由表的。路由表中包含的信息决定
了I P层所做的所有决策。
在3 . 3节中，我们列出了I P搜索路由表的几个步骤：
1) 搜索匹配的主机地址；
2) 搜索匹配的网络地址；
3) 搜索默认表项（默认表项一般在路由表中被指定为一个网络表项，其网络号为 0）。
匹配主机地址步骤始终发生在匹配网络地址步骤之前。
I P层进行的选路实际上是一种选路机制，它搜索路由表并决定向哪个网络接口发送分组。
这区别于选路策略，它只是一组决定把哪些路由放入路由表的规则。 I P执行选路机制，而路
由守护程序则一般提供选路策略。

* 路由表
在主机s v r 4上，我们先执行带-r选项的n e t s t a t命令
列出路由表，然后以-n选项再次执行该命令，以数字格式打印出I P地址（我们这样做是因为路由
表中的一些表项是网络地址，而不是主机地址。如果没有- n选项，n e t s t a t命令将搜索文件
/ e t c / n e t w o r k s并列出其中的网络名。这样会与另一种形式的名字 — 网络名加主机名相混淆）。
