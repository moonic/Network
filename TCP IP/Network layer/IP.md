# IP选路
选路是IP最重要的功能之一。图 9 - 1是I P层处理过程的简单流程。需要进行选路的数据报可以由本地主机产生，也可以由其他主机产生。在后一种情况下，主机必须配置成一个路由器，否则通过网络接口接收到的数据报，如果目的地址不是本机就要被丢弃（例如，悄无声息地被丢弃）。

在图9 - 1中，我们还描述了一个路由守护程序（ d a e m o n），通常这是一个用户进程。在
U n i x系统中，大多数普通的守护程序都是路由程序和网关程序（术语 d a e m o n指的是运行在后台的进程，它代表整个系统执行某些操作。 d a e m o n一般在系统引导时启动，在系统运行期间一直存在）。在某个给定主机上运行何种路由协议，如何在相邻路由器上交换选路信息，以及选路协议是如何工作的，所有这些问题都是非常复杂的,了解单个I P层如何作出路由决策。

图9 - 1所示的路由表经常被IP访问（繁忙的主机上一秒钟内可能要访问几百次）它被路由守护程序更新的频度却要低得多（可能大约 3 0秒种一次）。当接收到I C M P重定向，报文时，路由表也要被更新，这一点我们将在 9 . 5节讨论r o u t e命令时加以介绍。还将用n e t s t a t命令来显示路由表。


## 选路的原理
> 了解内核是如何维护路由表的。路由表中包含的信息决定了I P层所做的所有决策

* IP搜索路由表的几个步骤：
  1. 搜索匹配的主机地址；
  2. 搜索匹配的网络地址；
  3. 搜索默认表项（默认表项一般在路由表中被指定为一个网络表项，其网络号为 0）匹配主机地址步骤始终发生在匹配网络地址步骤之前。

* I P层进行的选路实际上是一种选路机制，它搜索路由表并决定向哪个网络接口发送分组。这区别于选路策略，它只是一组决定把哪些路由放入路由表的规则。 I P执行选路机制，而路由守护程序则一般提供选路策略。

* 简单路由表
  * 在主机s v r 4上，我们先执行带-r选项的n e t s t a t命令列出路由表
  * 然后以-n选项再次执行该命令，以数字格式打印出I P地址（我们这样做是因为路由表中的一些表项是网络地址，而不是主机地址
  * 如果没有- n选项，n e t s t a t命令将搜索文件/ e t c / n e t w o r k s并列出其中的网络名。这样会与另一种形式的名字 — 网络名加主机名相混淆）。

* 主机路由表的复杂性取决于主机所在网络的拓扑结构。
  1. 最简单的（也是最不令人感兴趣的）情况是主机根本没有与任何网络相连。 T C P / I P协议仍然能用于这样的主机，但是只能与自己本身通信！这种情况下的路由表只包含环回接口一项。
  2. 接下来的情况是主机连在一个局域网上，只能访问局域网上的主机。这时路由表包含两项：一项是环回接口，另一项是局域网（如以太网）。
  3. 如果主机能够通过单个路由器访问其他网络（如 I n t e r n e t）时，那么就要进行下一步。一般情况下增加一个默认表项指向该路由器。
  4. 如果要新增其他的特定主机或网络路由，那么就要进行最后一步。在我们的例子中，到主机s l i p的路由要通过路由器b s d i就是这样的例子。

* 根据上述I P操作的步骤使用这个路由表为主机svr4上的一些分组例子选择路由。
  1. 假定目的地址是主机 s u n，140.252.13.33。首先进行主机地址的匹配。路由表中的两个主机地址表项（slip和locahost均不匹配，接着进行网络地址匹配。这一次匹配成功，找到表项140.252.13.32（网络号和子网号都相同）因此使用e m d 0接口。这是一个直接路由，因此链路层地址将是目的端的地址。
  2. 假定目的地址是主机s l i p，140.252.13.65。首先在路由表搜索主机地址，并找到一个匹配地址。这是一个间接路由，因此目的端的 I P地址仍然是1 4 0 . 2 5 2 . 1 3 . 6 5，但是链路层地址必须是网关140.252.13.65的链路层地址，其接口名为e m d 0。
  3. 这一次我们通过I n t e r n e t给主机a w . c o m（192.207.117.2）发送一份数据报。首先在路由表中搜索主机地址，失败后进行网络地址匹配。最后成功地找到默认表项。该路由是一个间接路由，通过网关140.252.13.33，并使用接口名为emd0
  4. 在我们最后一个例子中，我们给本机发送一份数据报。有四种方法可以完成这件事，如用主机名、主机I P地址、环回名或者环回I P地址：


* 初始化路由表
  * 初始化一个接口时（通常是用i f c o n f i g命令设置接口地址），就为接口自动创建一个直接路由。对于点对点链路和环回接口来说，路由是到达主机（例如，设置 H标志）。对于广播接口来说，如以太网，路由是到达网络。
  * 到达主机或网络的路由如果不是直接相连的，那么就必须加入路由表。一个常用的方法是在系统引导时显式地在初始化文件中运行 r o u t e命令。在主机s v r 4上，我们运行下面两个命令来添加路由表中的表项：
  route add default sun 1
  route add slip bsdi 1
  * 第3个参数（d e f a u l t和s l i p）代表目的端，第4个参数代表网关（路由器），最后一个参数代表路由的度量( m e t r i c )。r o u t e命令在度量值大于0时要为该路由设置G标志，否则，当耗费值为0时就不设置G标志。


* 复杂的路由表
  * 路由表中的目的地址就是点对点链路的另一端 (即路由器n e t b), 网关地址为外出接口的本地I P地址( 140.252.1.29) (前面已经说过, n e t s t a t为直接路由打印出来的网关地址就是本地接口所用的I P地址)。
  * 默认的路由表项是一个到达网络的间接路由 (设置了G标志，但没有设置 H标志)网关地址是路由器的地址 ( 1 4 0 . 2 5 2 . 1 . 1 8 3，S L I P链路的另一端), 而不是S L I P链路的本地I P地址( 1 4 0 . 2 5 2 . 1 . 2 9 )。其原因还是因为是间接路由，不是直接路由。还应该指出的是，n e t s t a t输出的第3和第4行(接口名为s l 0)由S L I P软件在启动时创建并在关闭时删除.

* 没有到达目的地的路由
  * 假定对路由表的搜索能找到匹配的表项，即使匹配的是默认项。如果路由表中没有默认项，而又没有找到匹配项，这时会发生什么情况呢？
    * 结果取决于该I P数据报是由主机产生的还是被转发的（例如，我们就充当一个路由器）。如果数据报是由本地主机产生的，那么就给发送该数据报的应用程序返回一个差错，或者是“主机不可达差错”或者是“网络不可达差错”。
    * 如果是被转发的数据报那么就给原始发送端发送一份I C M P主机不可达的差错报文。下一节将讨论这种差错。

## ICMP重定向差错
* I P数据报应该被发送到另一个路由器时，收到数据报的路由器就要发送ICMP重定向差错报文给I P数据报的发送端
  1. 我们假定主机发送一份I P数据报给R 1。这种选路决策经常发生，因为 R 1是该主机的默认路由。
  2. R1收到数据报并且检查它的路由表，发现 R 2是发送该数据报的下一站。当它把数据报发送给R 2时，R 1检测到它正在发送的接口与数据报到达接口是相同的（即主机和两个路由器所在的L A N）。这样就给路由器发送重定向报文给原始发送端提供了线索。
  3. R1发送一份I C M P重定向报文给主机，告诉它以后把数据报发送给 R 2而不是R 1。

* 重定向使用
  * 重定向一般用来让具有很少选路信息的主机逐渐建立更完善的路由表
  * 主机启动时路由表中可以只有一个默认表项默认路由发生差错，默认路由器将通知它进行重定向，并允许主机对路由表作相应的改动。 
  * I C M P重定向允许T C P / I P主机在进行选路时不需要具备智能特性，而把所有的智能特性放在路由器端。
  * R 1和R2 必须知道有关相连网络的更多拓扑结构的信息，但是连在 L A N上的所有主机在启动时只需一个默认路由，通过接收重定向报文来逐步学习
  * 重定向报文只能由路由器生成，而不能由主机
生成。另外，重定向报文是为主机而不是为路由器使用的。假定路由器和其他一些路由器共
同参与某一种选路协议，则该协议就能消除重定向的需要

* 4 . 4 B S D系统中，当主机作为路由器使用时，要进行下列检查。在生成 I C M P重定向报文之前这些条件都要满足。
1. 出接口必须等于入接口。
2. 用于向外传送数据报的路由不能被 I C M P重定向报文创建或修改过，而且不能是路由器的默认路由。
3. 数据报不能用源站选路来转发。
4. 内核必须配置成可以发送重定向报文。
  * 内核变量取名为i p _ s e n d r e d i r e c t s或其他类似的名字（参见附录E）。大多数当
  * 前的系统（例如B S D、 SunOS 4.1.x、Solaris 2.x 及AIX 3.2.2）在默认条件下都设置该变量，使系统可以发送重定向报文。其他系统如SVR4则关闭了该项功能。
  * 一台4 . 4 B S D主机收到I C M P重定向报文后，在修改路由表之前要作一些检查。这是

* 为了防止路由器或主机的误操作，以及恶意用户的破坏，导致错误地修改系统路由表。
  1. 新的路由器必须直接与网络相连接。
  2. 重定向报文必须来自当前到目的地所选择的路由器。
  3. 重定向报文不能让主机本身作为路由器。
  4. 被修改的路由必须是一个间接路由。
  
* 关于重定向最后要指出的是，路由器应该发送的只是对主机的重定向而不是对网络的重定向。子网的存在使得难于准确指明何时应发送对网络的重定
向而不是对主机的重定向。只当路由器发送了错误的类型时，一些主机才把收到的对网络的重定向当作对主机的重定向来处理。


* ICMP路由器发现报文
  * 初始化路由表的方法，即在配置文件中指定静态路由。常用来设置默认路由。另一是利用 I C M P路由器通告和请求报文。
  * 一般认为，主机在引导以后要广播或多播传送一份路由器请求报文。一台或更多台路由器响应一份路由器通告报文。另外，路由器定期地广播或多播传送它们的路由器通告报文，允许每个正在监听的主机相应地更新它们的路由表。
  * RFC 1256 [Deering 1991]确定了这两种I C M P报文的格式。I C M P路由器请求报文的格式如图9 - 6所示。I C M P路由器通告报文的格式如图9 - 7所示。路由器在一份报文中可以通告多个地址。地址数指的是报文中所含的地址数。地址项大小指的是每个路由器地址 32 bit字的数目，始终为 2。生存期指的是通告地址有效的时间（秒数）。
  * 一对或多对 I P地址和优先级。 I P地址必须是发送路由器的某个地址。优先级是一个有符号的32 bit整数，指出该I P地址作为默认路由器地址的优先等级，这是与子网上的其他路由器相比较而言的。值越大说明优先级越高。优先级为 0 x 8 0 0 0 0 0 0 0说明对应的地址不能作为默认路由器地址使用，尽管它也包含中通告报文中。优先级的默认值一般为 0。

## 小结
* I P路由操作对于运行T C P／I P的系统来说是最基本的，不管是主机还是路由器。路由表项的内容很简单，包括： 5 bit标志、目的I P地址（主机、网络或默认）、下一站路由器的I P地址（间接路由）或者本地接口的 I P地址（直接路由）及指向本地接口的指针。
* 主机表项比网络表项具有更高的优先级，而网络表项比默认项具有更高的优先级。
*  系统产生的或转发的每份IP数据报都要搜索路由表，它可以被路由守护程序或 I C M P重定向报文修改。系统在默认情况下不转发数据报，除非进行特殊的配置。
* 用 r o u t e命令可以进入静态路由，可以利用新 I C M P路由器发现报文来初始化默认表项，并进行动态修改。主机在启动时只有一个简单的路由表，它可以被来自默认路由器的 I C M P重定向报文动态修改。
