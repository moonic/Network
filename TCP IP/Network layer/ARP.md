# ARP：地址解析协议
> IP地址到对应的硬件地址之间提供动态映射
> 对 TCP/IP协议簇有意义的I P地址数据链路如以太网或令牌环网都有自己的寻址机制（常常为 48 bit地址）使用数据链路的任何网络层都必须遵从一个网络如以太网可以同时被不同的网络层使用
> 一台主机把以太网数据帧发送到位于同一局域网上的另一台主机时，是根据 48 bit的以太网地址来确定目的接口的。


*  ftp bsdi
  1. 应用程序FTP客户端调用函数gethostbyname把主机名（bsdi）转换成32 bit的IP地址。函数在D N S（域名系统）中称作解析器，这个转换过程或者使用DNS，或者在较小网络中使用一个静态的主机文件（/e t c / h o s t s）。
  2. FTP客户端请求TCP用得到的iP地址建立连接。
  3. TCP发送一个连接请求分段到远端的主机，即用上述IP地址发送一份 I P数据报
  4. 目的主机在本地网络上（如以太网、令牌环网或点对点链接的另一端），那么I P数据报可以直接送到目的主机上。如是远程网络上，那么就通过IP选路函数来确定位于本地网络上的下一站路由器地址，并让它转发 I P数据报。I P数据报都是被送到位于本地网络上的一台主机或路由器。
  5. 如果是以太网，发送端主机必须把 32 bit的I P地址变换成48bit的地址。



##  ARP：地址解析协议使用
> 从逻辑Internet地址到对应的物理硬件地址需要进行翻译。这就是 A R P的功能。A R P本来是用于广播网络的，有许多主机或路由器连在同一个网络上。

6. A R P发送一份称作A R P请求的以太网数据帧给以太网上的每个主机。这个过程称作广
7. 目的主机的A R P层收到这份广播报文后，识别出这是发送端在寻问它的 I P地址，于是
发送一个A R P应答。这个A R P应答包含I P地址及对应的硬件地址。
8. 收到A R P应答后，使A R P进行请求—应答交换的I P数据报现在就可以传送了。
9. 发送I P数据报到目的主机。
  * A R P背后有一个基本概念，那就是网络接口有一个硬件地址（一个 48 bit的值，标识不同的以太网或令牌环网络接口）。在硬件层次上进行的数据帧交换必须有正确的接口地址。但T C P / I P有自己的地址：32 bit的I P地址内核（如以太网驱动程序）必须知道目的端的硬件地址才能发送数据。 A R P的功能是
在32 bit的I P地址和采用不同网络技术的硬件地址之间提供动态映射。


## ARP高速缓存
* 每个主机上都有一个 A R P高速缓存存放了最近Internet地址到硬件地址之间的映射记录每一项的生存时间一般为 2 0分钟起始时间从被创建时开始算起
* 48 bit的以太网地址用6个十六进制的数来表示，中间以冒号隔开

## ARP的分组格式
* 以太网上解析I P地址时，A R P请求和应答分组的格式（A R P可以用于其他类型的网络解析IP地址以外的地址帧类型字段的前四个字段指定了最后四个字段的类型和长度）以太网报头中的前两个字段是以太网的源地址和目的地址。目的地址为全 1的特殊地址是
广播地址。电缆上的所有以太网接口都要接收广播的数据帧。
两个字节长的以太网帧类型表示后面数据的类型。对于 A R P请求或应答来说，该字段的
值为0 x 0 8 0 6。
形容词h a r d w a r e (硬件)和p r o t o c o l (协议)用来描述A R P分组中的各个字段。例如，一个 A R P
请求分组询问协议地址（这里是I P地址）对应的硬件地址（这里是以太网地址）。
硬件类型字段表示硬件地址的类型。它的值为 1即表示以太网地址。协议类型字段表示要
映射的协议地址类型。它的值为 0 x 0 8 0 0即表示I P地址。它的值与包含 I P数据报的以太网数据
帧中的类型字段的值相同，这是有意设计的（参见图 2 - 1）。
接下来的两个1字节的字段，硬件地址长度和协议地址长度分别指出硬件地址和协议地址
的长度，以字节为单位。对于以太网上 I P地址的A R P请求或应答来说，它们的值分别为 6和4。
操作字段指出四种操作类型，它们是 A R P请求（值为1）、A R P应答（值为2）、R A R P请求
（值为3）和R A R P应答（值为4）（我们在第5章讨论R A R P）。这个字段必需的，因为 A R P请求
和A R P应答的帧类型字段值是相同的。
接下来的四个字段是发送端的硬件地址（在本例中是以太网地址）、发送端的协议地址
（I P地址）、目的端的硬件地址和目的端的协议地址。注意，这里有一些重复信息：在以太网


## 不存在主机的ARP请求
> 查询的主机已关机或不存在会发生什么情况呢？为此我们指定一个并不存在的I n t e r n e t地址 — 根据网络号和子网号所对应的网络确实存在
多次进行 A R P请求：第1次请求发生后5 . 5秒进行第2次请求，在2 4秒
之后又进行第3次请求（在第2 1章我们将看到T C P的超时和重发算法的细节）。t c p d u m p命令
输出的超时限制为 2 9 . 5秒。但是，在t e l n e t命令使用前后分别用 d a t e命令检查时间，可以
发现Te l n e t客户端的连接请求似乎在大约 7 5秒后才放弃。事实上，我们在后面将看到，大多数
的B S D实现把完成T C P连接请求的时间限制设置为7 5秒。

注意，在线路上始终看不到T C P的报文段。我们能看到的是A R P请求。直到A R P回答返回
时，T C P报文段才可以被发送，因为硬件地址到这时才可能知道。如果我们用过滤模式运行
t c p d u m p命令，只查看T C P数据，那么将没有任何输出。


## ARP代理
如果A R P请求是从一个网络的主机发往另一个网络上的主机，那么连接这两个网络的路
由器就可以回答该请求，这个过程称作委托 A R P或A R P代理(Proxy ARP)。这样可以欺骗发起
A R P请求的发送端，使它误以为路由器就是目的主机，而事实上目的主机是在路由器的“另
一边”。路由器的功能相当于目的主机的代理，把分组从其他主机转发给它。

