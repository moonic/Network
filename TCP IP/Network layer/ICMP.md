# ICMP Internet控制报文协议
> I C M P经常被认为是 I P层的一个组成部分 传递差错报文以及其他需要注意信息
ICMP报文被IP层或更高层协议（ T C P或U D P）使用，ICMP报文将错报文返回给用户进程

* ICMP报文的类型
  * 不同类型由报文中的类型字段和代码字段来共同决定对 I C M P差错报文有时需要作特殊处理，因此我们需要对它们进行区分
  * 发送一份ICMP差错报文时，报文始终包含I P的首部ICMP差错报文IP数据报的前8个字节 接收 I C M P差错报文的模块就会把它与某个特定的协议（根据 IP数据报首的协议字段）和用户进程（根据包IP数据报前8个字节中的TCP或UDP报文首部中的TCP或UDP端口号）联系起来

* 不会导致产生I C M P差错报文
  1. ICMP差错报文（但是，I C M P查询报文可能会产生I C M P差错报文）。
  2. 目的地址是广播地址或多播地址的I P数据报。
  3. 作为链路层广播的数据报。
  4. 不是I P分片的第一片
  5. 源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。
  * 这些规则是为了防止过去允许I C M P差错报文对广播分组响应所带来的广播风暴。  
  
* ICMP地址掩码请求与应答
  * I C M P地址掩码请求用于无盘系统在引导中获取自己的子网掩码系统广播它的I C M P请求报文（与无盘系统在引导过程中用 R A R P获取I P地址是类似的）无盘系统获取子网掩码的另一个方法是 B O O T P协议
  
  * I C M P报文中的标识符和序列号字段由发送端任意选择设定，这些值在应答中将被返回。这样，发送端就可以把应答与请求进行匹配。
接下来，b s d i广播应答，而s v r 4却只把应答传给请求主机。通常，应答地址必须是单
播地址，除非请求端的源 I P地址是0 . 0 . 0 . 0。本例不属于这种情况，因此，把应答发送到广播
地址是B S D / 3 8 6的一个内部差错。
R F C规定，除非系统是地址掩码的授权代理，否则它不能发送地址掩码应答（为
了成为授权代理，它必须进行特殊配置，以发送这些应答。参见附录 E）。但是，正如
我们从本例中看到的那样，大多数主机在收到请求时都发送一个应答，甚至有一些主
机还发送差错的应答。
最后一点可以通过下面的例子来说明。我们向本机 I P地址和环回地址分别发送地址掩码
请求：
sun % icmpaddrmask sun
received mask= ff000000, from 140.252.13.33
sun % icmpaddrmask localhost
received mask= ff000000, from 127.0.0.1

* ICMP时间戳请求与应答
I C M P时间戳请求允许系统向另一个系统查询当前的时间。返回的建议值是自午夜开始计
算的毫秒数，协调的统一时间（ Coordinated Universal Time, UTC）（早期的参考手册认为
U T C是格林尼治时间）。这种I C M P报文的好处是它提供了毫秒级的分辨率，而利用其他方法
从别的主机获取的时间（如某些 U n i x系统提供的r d a t e命令）只能提供秒级的分辨率。

* ICMP端口不可达差错
 I C M P查询报文 — 地址掩码和时间戳查询及应答。现在来分析一
种I C M P差错报文，即端口不可达报文，它是 I C M P目的不可到达报文中的一种，以此来看一
看I C M P差错报文中所附加的信息。使用U D P（见第11章）来查看它。
U D P的规则之一是，如果收到一份 U D P数据报而目的端口与某个正在使用的进程不相符，
那么U D P返回一个I C M P不可达报文。可以用T F T P来强制生成一个端口不可达报文（ T F T P将
在第1 5章描述）。
对于T F T P服务器来说， U D P的公共端口号是 6 9。但是大多数的 T F T P客户程序允许用
c o n n e c t命令来指定一个不同的端口号。这里，我们就用它来指定 8 8 8 8端口：
c o n n e c t命令首先指定要连接的主机名及其端口号，接着用 g e t命令来取文件。敲入 g e t
命令后，一份U D P数据报就发送到主机s v r 4上的8 8 8 8端口。t c p d u m p命令引起的报文交换结果
在U D P数据报送到s v r 4之前，要先发送一份A R P请求来确定它的硬件地址（第1行）。接着
返回A R P应答（第2行），然后才发送U D P数据报（第3行）（在t c p d u m p的输出中保留A R P请
求和应答是为了提醒我们，这些报文交换可能在第一个 I P数据报从一个主机发送到另一个主
机之前是必需的。在本书以后的章节中，如果这些报文与讨论的题目不相关，那么我们将省
略它们）。
一个I C M P端口不可达差错是立刻返回的（第 4行）。但是，T F T P客户程序看上去似乎忽
略了这个I C M P报文，而在5秒钟之后又发送了另一份 U D P数据报（第5行）。在客户程序放弃之前重发了三次
